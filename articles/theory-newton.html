<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Exact Moment Matching: The A2 Newton Algorithm ‚Ä¢ DPprior</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="‚Äùimage/svg+xml‚Äù" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Exact Moment Matching: The A2 Newton Algorithm">
<meta name="description" content="A rigorous treatment of the Newton-Raphson algorithm for exact moment matching,  including score-based Jacobian derivation, convergence analysis, numerical  safeguards, and comparison with the A1 closed-form approximation.
">
<meta property="og:description" content="A rigorous treatment of the Newton-Raphson algorithm for exact moment matching,  including score-based Jacobian derivation, convergence analysis, numerical  safeguards, and comparison with the A1 closed-form approximation.
">
<meta property="og:image" content="https://joonho112.github.io/DPprior/logo.svg">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">DPprior</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-vignettes" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Vignettes</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-vignettes">
<li><h6 class="dropdown-header" data-toc-skip>--- Applied Track ---</h6></li>
    <li><a class="dropdown-item" href="../articles/introduction.html">Introduction</a></li>
    <li><a class="dropdown-item" href="../articles/quick-start.html">Quick Start</a></li>
    <li><a class="dropdown-item" href="../articles/applied-guide.html">Applied Guide</a></li>
    <li><a class="dropdown-item" href="../articles/dual-anchor.html">Dual-Anchor Framework</a></li>
    <li><a class="dropdown-item" href="../articles/diagnostics.html">Diagnostics</a></li>
    <li><a class="dropdown-item" href="../articles/case-studies.html">Case Studies</a></li>
    <li><h6 class="dropdown-header" data-toc-skip>--- Methodological Track ---</h6></li>
    <li><a class="dropdown-item" href="../articles/theory-overview.html">Theory Overview</a></li>
    <li><a class="dropdown-item" href="../articles/theory-stirling.html">Stirling Numbers</a></li>
    <li><a class="dropdown-item" href="../articles/theory-approximations.html">Approximations (A1)</a></li>
    <li><a class="dropdown-item" href="../articles/theory-newton.html">Newton Algorithm (A2)</a></li>
    <li><a class="dropdown-item" href="../articles/theory-weights.html">Weight Distributions</a></li>
    <li><a class="dropdown-item" href="../articles/api-reference.html">API Reference</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/joonho112/DPprior/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.svg" class="logo" alt=""><h1>Exact Moment Matching: The A2 Newton Algorithm</h1>
                        <h4 data-toc-skip class="author">JoonHo Lee</h4>
            
            <h4 data-toc-skip class="date">2026-02-13</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/joonho112/DPprior/blob/main/vignettes/theory-newton.Rmd" class="external-link"><code>vignettes/theory-newton.Rmd</code></a></small>
      <div class="d-none name"><code>theory-newton.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="overview">Overview<a class="anchor" aria-label="anchor" href="#overview"></a>
</h2>
<p>This vignette provides a rigorous mathematical treatment of the
<strong>A2 Newton algorithm</strong> (A2-MN) used in the DPprior package
to achieve exact moment matching for Gamma hyperprior elicitation. While
the A1 closed-form approximation (see
<code><a href="../articles/theory-approximations.html">vignette("theory-approximations")</a></code>) provides a fast
initialization, it introduces systematic errors that can be substantial
for small-to-moderate
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>J</mi><annotation encoding="application/x-tex">J</annotation></semantics></math>‚Äîprecisely
the regime most relevant for multisite trials and meta-analyses in
education.</p>
<p>We cover:</p>
<ol style="list-style-type: decimal">
<li>The problem formulation: moment matching as root-finding</li>
<li>The Jacobian: score-based derivation (avoiding finite
differences)</li>
<li>Convergence analysis: local quadratic convergence</li>
<li>Numerical safeguards: damping, positivity constraints, and fallback
strategies</li>
<li>A1 vs.¬†A2 comparison: quantifying the improvement</li>
</ol>
<p>Throughout, we carefully distinguish between <strong>established
results</strong> from the numerical analysis literature and
<strong>novel contributions</strong> of this work in applying these
methods to DP hyperprior calibration.</p>
</div>
<div class="section level2">
<h2 id="problem-formulation">1. Problem Formulation<a class="anchor" aria-label="anchor" href="#problem-formulation"></a>
</h2>
<div class="section level3">
<h3 id="the-inverse-problem">1.1 The Inverse Problem<a class="anchor" aria-label="anchor" href="#the-inverse-problem"></a>
</h3>
<p>Recall from <code><a href="../articles/theory-overview.html">vignette("theory-overview")</a></code> that we seek
Gamma hyperparameters
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="true" form="prefix">(</mo><mi>a</mi><mo>,</mo><mi>b</mi><mo stretchy="true" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">(a, b)</annotation></semantics></math>
such that the induced marginal distribution of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>K</mi><mi>J</mi></msub><annotation encoding="application/x-tex">K_J</annotation></semantics></math>
under
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Œ±</mi><mo>‚àº</mo><mtext mathvariant="normal">Gamma</mtext><mrow><mo stretchy="true" form="prefix">(</mo><mi>a</mi><mo>,</mo><mi>b</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\alpha \sim \text{Gamma}(a, b)</annotation></semantics></math>
has user-specified moments:
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>M</mi><mn>1</mn></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>a</mi><mo>,</mo><mi>b</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>:=</mo><mi>ùîº</mi><mrow><mo stretchy="true" form="prefix">[</mo><msub><mi>K</mi><mi>J</mi></msub><mo>‚à£</mo><mi>a</mi><mo>,</mo><mi>b</mi><mo stretchy="true" form="postfix">]</mo></mrow><mo>=</mo><msub><mi>Œº</mi><mi>K</mi></msub><mo>,</mo><mspace width="1.0em"></mspace><mi>V</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>a</mi><mo>,</mo><mi>b</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>:=</mo><mtext mathvariant="normal">Var</mtext><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>K</mi><mi>J</mi></msub><mo>‚à£</mo><mi>a</mi><mo>,</mo><mi>b</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><msubsup><mi>œÉ</mi><mi>K</mi><mn>2</mn></msubsup><mi>.</mi></mrow><annotation encoding="application/x-tex">
M_1(a, b) := \mathbb{E}[K_J \mid a, b] = \mu_K, \quad
V(a, b) := \text{Var}(K_J \mid a, b) = \sigma^2_K.
</annotation></semantics></math></p>
<p>The A1 approximation solves this problem under a Negative Binomial
proxy, yielding closed-form expressions that are asymptotically exact as
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>J</mi><mo>‚Üí</mo><mi>‚àû</mi></mrow><annotation encoding="application/x-tex">J \to \infty</annotation></semantics></math>.
However, for finite
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>J</mi><annotation encoding="application/x-tex">J</annotation></semantics></math>,
the A1 solution
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>a</mi><mn>0</mn></msub><mo>,</mo><msub><mi>b</mi><mn>0</mn></msub><mo stretchy="true" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">(a_0, b_0)</annotation></semantics></math>
may not satisfy the exact moment equations.</p>
<p><strong>Goal of A2.</strong> Find
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="true" form="prefix">(</mo><msup><mi>a</mi><mo>*</mo></msup><mo>,</mo><msup><mi>b</mi><mo>*</mo></msup><mo stretchy="true" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">(a^*, b^*)</annotation></semantics></math>
such that the <em>exact</em> marginal moments, computed via
Gauss-Laguerre quadrature (see
<code><a href="../articles/theory-overview.html">vignette("theory-overview")</a></code>), match the targets precisely:
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>F</mi><mrow><mo stretchy="true" form="prefix">(</mo><msup><mi>a</mi><mo>*</mo></msup><mo>,</mo><msup><mi>b</mi><mo>*</mo></msup><mo stretchy="true" form="postfix">)</mo></mrow><mo>:=</mo><mrow><mo stretchy="true" form="prefix">(</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><msub><mi>M</mi><mn>1</mn></msub><mrow><mo stretchy="true" form="prefix">(</mo><msup><mi>a</mi><mo>*</mo></msup><mo>,</mo><msup><mi>b</mi><mo>*</mo></msup><mo stretchy="true" form="postfix">)</mo></mrow><mo>‚àí</mo><msub><mi>Œº</mi><mi>K</mi></msub></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mi>V</mi><mrow><mo stretchy="true" form="prefix">(</mo><msup><mi>a</mi><mo>*</mo></msup><mo>,</mo><msup><mi>b</mi><mo>*</mo></msup><mo stretchy="true" form="postfix">)</mo></mrow><mo>‚àí</mo><msubsup><mi>œÉ</mi><mi>K</mi><mn>2</mn></msubsup></mtd></mtr></mtable><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mn>ùüé</mn><mi>.</mi></mrow><annotation encoding="application/x-tex">
F(a^*, b^*) := \begin{pmatrix} M_1(a^*, b^*) - \mu_K \\ 
                               V(a^*, b^*) - \sigma^2_K \end{pmatrix} = \mathbf{0}.
</annotation></semantics></math></p>
</div>
<div class="section level3">
<h3 id="newton-raphson-iteration">1.2 Newton-Raphson Iteration<a class="anchor" aria-label="anchor" href="#newton-raphson-iteration"></a>
</h3>
<p><strong>Attribution.</strong> Newton‚Äôs method for systems of
nonlinear equations is a classical algorithm in numerical analysis; see
Ortega &amp; Rheinboldt (1970) for the theoretical foundations.</p>
<p><strong>Novel Contribution.</strong> This work applies Newton‚Äôs
method to the specific problem of DP concentration prior calibration,
with (i) exact Jacobian computation via score identities, (ii) A1 as a
principled initializer, and (iii) a complete set of numerical safeguards
for robust convergence.</p>
<p>Given the current iterate
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>a</mi><mi>t</mi></msub><mo>,</mo><msub><mi>b</mi><mi>t</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">(a_t, b_t)</annotation></semantics></math>,
the Newton update is:
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mrow><mo stretchy="true" form="prefix">(</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><msub><mi>a</mi><mrow><mi>t</mi><mo>+</mo><mn>1</mn></mrow></msub></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><msub><mi>b</mi><mrow><mi>t</mi><mo>+</mo><mn>1</mn></mrow></msub></mtd></mtr></mtable><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mrow><mo stretchy="true" form="prefix">(</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><msub><mi>a</mi><mi>t</mi></msub></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><msub><mi>b</mi><mi>t</mi></msub></mtd></mtr></mtable><mo stretchy="true" form="postfix">)</mo></mrow><mo>‚àí</mo><msubsup><mi>ùêâ</mi><mi>F</mi><mrow><mo>‚àí</mo><mn>1</mn></mrow></msubsup><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>a</mi><mi>t</mi></msub><mo>,</mo><msub><mi>b</mi><mi>t</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>‚ãÖ</mo><mi>F</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>a</mi><mi>t</mi></msub><mo>,</mo><msub><mi>b</mi><mi>t</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>,</mo></mrow><annotation encoding="application/x-tex">
\begin{pmatrix} a_{t+1} \\ b_{t+1} \end{pmatrix} = 
\begin{pmatrix} a_t \\ b_t \end{pmatrix} - 
\mathbf{J}_F^{-1}(a_t, b_t) \cdot F(a_t, b_t),
</annotation></semantics></math> where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>ùêâ</mi><mi>F</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>a</mi><mo>,</mo><mi>b</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\mathbf{J}_F(a, b)</annotation></semantics></math>
is the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2</mn><mo>√ó</mo><mn>2</mn></mrow><annotation encoding="application/x-tex">2 \times 2</annotation></semantics></math>
Jacobian matrix:
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>ùêâ</mi><mi>F</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>a</mi><mo>,</mo><mi>b</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mrow><mo stretchy="true" form="prefix">(</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><mi>‚àÇ</mi><msub><mi>M</mi><mn>1</mn></msub><mi>/</mi><mi>‚àÇ</mi><mi>a</mi></mtd><mtd columnalign="center" style="text-align: center"><mi>‚àÇ</mi><msub><mi>M</mi><mn>1</mn></msub><mi>/</mi><mi>‚àÇ</mi><mi>b</mi></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mi>‚àÇ</mi><mi>V</mi><mi>/</mi><mi>‚àÇ</mi><mi>a</mi></mtd><mtd columnalign="center" style="text-align: center"><mi>‚àÇ</mi><mi>V</mi><mi>/</mi><mi>‚àÇ</mi><mi>b</mi></mtd></mtr></mtable><mo stretchy="true" form="postfix">)</mo></mrow><mi>.</mi></mrow><annotation encoding="application/x-tex">
\mathbf{J}_F(a, b) = \begin{pmatrix} 
\partial M_1 / \partial a &amp; \partial M_1 / \partial b \\
\partial V / \partial a &amp; \partial V / \partial b 
\end{pmatrix}.
</annotation></semantics></math></p>
<div class="figure" style="text-align: center">
<img src="theory-newton_files/figure-html/newton-schematic-1.png" class="r-plt" alt="Schematic of Newton's method converging to the root of F(a,b) = 0." width="85%"><p class="caption">
Schematic of Newton‚Äôs method converging to the root of F(a,b) = 0.
</p>
</div>
</div>
</div>
<div class="section level2">
<h2 id="the-jacobian-score-based-derivation">2. The Jacobian: Score-Based Derivation<a class="anchor" aria-label="anchor" href="#the-jacobian-score-based-derivation"></a>
</h2>
<div class="section level3">
<h3 id="score-function-identities">2.1 Score Function Identities<a class="anchor" aria-label="anchor" href="#score-function-identities"></a>
</h3>
<p><strong>Attribution.</strong> The use of score functions for
computing derivatives of expectations is a standard technique in
statistical theory; see Casella &amp; Berger (2002, Chapter 7). The key
identity is:
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mi>‚àÇ</mi><mrow><mi>‚àÇ</mi><mi>Œ∏</mi></mrow></mfrac><mi>ùîº</mi><mrow><mo stretchy="true" form="prefix">[</mo><mi>g</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>Œ±</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">]</mo></mrow><mo>=</mo><mi>ùîº</mi><mrow><mo stretchy="true" form="prefix">[</mo><mi>g</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>Œ±</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>‚ãÖ</mo><msub><mi>s</mi><mi>Œ∏</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>Œ±</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">]</mo></mrow><mo>,</mo></mrow><annotation encoding="application/x-tex">
\frac{\partial}{\partial \theta} \mathbb{E}[g(\alpha)] = 
\mathbb{E}\left[g(\alpha) \cdot s_\theta(\alpha)\right],
</annotation></semantics></math> where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>s</mi><mi>Œ∏</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>Œ±</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>:=</mo><mfrac><mi>‚àÇ</mi><mrow><mi>‚àÇ</mi><mi>Œ∏</mi></mrow></mfrac><mo>log</mo><mi>p</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>Œ±</mi><mo>‚à£</mo><mi>Œ∏</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">s_\theta(\alpha) := \frac{\partial}{\partial \theta} \log p(\alpha \mid \theta)</annotation></semantics></math>
is the score function.</p>
<p><strong>Novel Contribution.</strong> This work applies these
identities specifically to the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>K</mi><mi>J</mi></msub><annotation encoding="application/x-tex">K_J</annotation></semantics></math>
moment functions, enabling exact Jacobian computation without finite
differences.</p>
<p>For the
Gamma<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="true" form="prefix">(</mo><mi>a</mi><mo>,</mo><mi>b</mi><mo stretchy="true" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">(a, b)</annotation></semantics></math>
distribution (shape
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>a</mi><annotation encoding="application/x-tex">a</annotation></semantics></math>,
rate
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>b</mi><annotation encoding="application/x-tex">b</annotation></semantics></math>),
the score functions are:
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>s</mi><mi>a</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>Œ±</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mo>log</mo><mi>b</mi><mo>‚àí</mo><mi>œà</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>a</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>+</mo><mo>log</mo><mi>Œ±</mi><mo>,</mo><mspace width="1.0em"></mspace><msub><mi>s</mi><mi>b</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>Œ±</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mfrac><mi>a</mi><mi>b</mi></mfrac><mo>‚àí</mo><mi>Œ±</mi><mo>,</mo></mrow><annotation encoding="application/x-tex">
s_a(\alpha) = \log b - \psi(a) + \log \alpha, \quad
s_b(\alpha) = \frac{a}{b} - \alpha,
</annotation></semantics></math> where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>œà</mi><annotation encoding="application/x-tex">\psi</annotation></semantics></math>
denotes the digamma function.</p>
<p>A fundamental property is that
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ùîº</mi><mrow><mo stretchy="true" form="prefix">[</mo><msub><mi>s</mi><mi>Œ∏</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>Œ±</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">]</mo></mrow><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">\mathbb{E}[s_\theta(\alpha)] = 0</annotation></semantics></math>,
which serves as a numerical verification check.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Visualize score functions</span></span>
<span><span class="va">a</span> <span class="op">&lt;-</span> <span class="fl">2</span></span>
<span><span class="va">b</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span></span>
<span><span class="va">alpha_grid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">5</span>, length.out <span class="op">=</span> <span class="fl">200</span><span class="op">)</span></span>
<span></span>
<span><span class="va">score_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  alpha <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">alpha_grid</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>  score <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="../reference/score_a.html">score_a</a></span><span class="op">(</span><span class="va">alpha_grid</span>, <span class="va">a</span>, <span class="va">b</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="../reference/score_b.html">score_b</a></span><span class="op">(</span><span class="va">alpha_grid</span>, <span class="va">a</span>, <span class="va">b</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  Type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"s_a(Œ±) = log(b) - œà(a) + log(Œ±)"</span>, </span>
<span>               <span class="st">"s_b(Œ±) = a/b - Œ±"</span><span class="op">)</span>, each <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">alpha_grid</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="va">score_df</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">alpha</span>, y <span class="op">=</span> <span class="va">score</span>, color <span class="op">=</span> <span class="va">Type</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_line</span><span class="op">(</span>linewidth <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_hline</span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">0</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span>, color <span class="op">=</span> <span class="st">"gray50"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_color_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="va">palette_main</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html" class="external-link">expression</a></span><span class="op">(</span><span class="va">alpha</span><span class="op">)</span>,</span>
<span>    y <span class="op">=</span> <span class="st">"Score function value"</span>,</span>
<span>    title <span class="op">=</span> <span class="st">"Gamma Score Functions"</span>,</span>
<span>    subtitle <span class="op">=</span> <span class="st">"a = 2, b = 1; note that E[s_Œ∏(Œ±)] = 0"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_minimal</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span>, legend.title <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="theory-newton_files/figure-html/score-functions-1.png" class="r-plt" alt="Score functions for the Gamma distribution with a = 2, b = 1." width="85%"><p class="caption">
Score functions for the Gamma distribution with a = 2, b = 1.
</p>
</div>
</div>
<div class="section level3">
<h3 id="jacobian-formulas-corollary-1">2.2 Jacobian Formulas (Corollary 1)<a class="anchor" aria-label="anchor" href="#jacobian-formulas-corollary-1"></a>
</h3>
<p>Using the score identities, we derive closed-form expressions for the
Jacobian entries.</p>
<p><strong>Corollary 1</strong> (Closed Jacobian formulas; Lee, 2026,
Section 3.2).</p>
<p><em>Define the auxiliary expectations:</em>
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>m</mi><mi>r</mi></msub><mo>:=</mo><mi>ùîº</mi><mrow><mo stretchy="true" form="prefix">[</mo><msub><mi>Œ∫</mi><mi>J</mi></msub><msup><mrow><mo stretchy="true" form="prefix">(</mo><mi>Œ±</mi><mo stretchy="true" form="postfix">)</mo></mrow><mi>r</mi></msup><mo stretchy="true" form="postfix">]</mo></mrow><mo>,</mo><mspace width="1.0em"></mspace><mi>r</mi><mo>‚àà</mo><mo stretchy="false" form="prefix">{</mo><mn>1</mn><mo>,</mo><mn>2</mn><mo stretchy="false" form="postfix">}</mo><mo>,</mo><mspace width="2.0em"></mspace><msub><mi>v</mi><mn>1</mn></msub><mo>:=</mo><mi>ùîº</mi><mrow><mo stretchy="true" form="prefix">[</mo><msub><mi>v</mi><mi>J</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>Œ±</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">]</mo></mrow><mo>,</mo></mrow><annotation encoding="application/x-tex">
m_r := \mathbb{E}[\kappa_J(\alpha)^r], \quad r \in \{1, 2\}, \qquad
v_1 := \mathbb{E}[v_J(\alpha)],
</annotation></semantics></math><em>where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Œ∫</mi><mi>J</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>Œ±</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mi>ùîº</mi><mrow><mo stretchy="true" form="prefix">[</mo><msub><mi>K</mi><mi>J</mi></msub><mo stretchy="false" form="prefix">|</mo><mi>Œ±</mi><mo stretchy="true" form="postfix">]</mo></mrow></mrow><annotation encoding="application/x-tex">\kappa_J(\alpha) = \mathbb{E}[K_J | \alpha]</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>v</mi><mi>J</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>Œ±</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mtext mathvariant="normal">Var</mtext><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>K</mi><mi>J</mi></msub><mo stretchy="false" form="prefix">|</mo><mi>Œ±</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">v_J(\alpha) = \text{Var}(K_J | \alpha)</annotation></semantics></math>
are the conditional moments.</em></p>
<p><em>Then
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>M</mi><mn>1</mn></msub><mo>=</mo><msub><mi>m</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">M_1 = m_1</annotation></semantics></math>,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi><mo>=</mo><msub><mi>v</mi><mn>1</mn></msub><mo>+</mo><msub><mi>m</mi><mn>2</mn></msub><mo>‚àí</mo><msubsup><mi>m</mi><mn>1</mn><mn>2</mn></msubsup></mrow><annotation encoding="application/x-tex">V = v_1 + m_2 - m_1^2</annotation></semantics></math>
(law of total variance), and the Jacobian entries are:</em>
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mrow><mi>‚àÇ</mi><msub><mi>M</mi><mn>1</mn></msub></mrow><mrow><mi>‚àÇ</mi><mi>Œ∏</mi></mrow></mfrac><mo>=</mo><mi>ùîº</mi><mrow><mo stretchy="true" form="prefix">[</mo><msub><mi>Œ∫</mi><mi>J</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>Œ±</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>‚ãÖ</mo><msub><mi>s</mi><mi>Œ∏</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>Œ±</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">]</mo></mrow><mo>,</mo><mspace width="1.0em"></mspace><mi>Œ∏</mi><mo>‚àà</mo><mo stretchy="false" form="prefix">{</mo><mi>a</mi><mo>,</mo><mi>b</mi><mo stretchy="false" form="postfix">}</mo><mo>,</mo></mrow><annotation encoding="application/x-tex">
\frac{\partial M_1}{\partial \theta} = \mathbb{E}[\kappa_J(\alpha) \cdot s_\theta(\alpha)], 
\quad \theta \in \{a, b\},
</annotation></semantics></math><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mrow><mi>‚àÇ</mi><mi>V</mi></mrow><mrow><mi>‚àÇ</mi><mi>Œ∏</mi></mrow></mfrac><mo>=</mo><mfrac><mrow><mi>‚àÇ</mi><msub><mi>v</mi><mn>1</mn></msub></mrow><mrow><mi>‚àÇ</mi><mi>Œ∏</mi></mrow></mfrac><mo>+</mo><mfrac><mrow><mi>‚àÇ</mi><msub><mi>m</mi><mn>2</mn></msub></mrow><mrow><mi>‚àÇ</mi><mi>Œ∏</mi></mrow></mfrac><mo>‚àí</mo><mn>2</mn><msub><mi>m</mi><mn>1</mn></msub><mfrac><mrow><mi>‚àÇ</mi><msub><mi>m</mi><mn>1</mn></msub></mrow><mrow><mi>‚àÇ</mi><mi>Œ∏</mi></mrow></mfrac><mo>,</mo></mrow><annotation encoding="application/x-tex">
\frac{\partial V}{\partial \theta} = \frac{\partial v_1}{\partial \theta} + 
\frac{\partial m_2}{\partial \theta} - 2 m_1 \frac{\partial m_1}{\partial \theta},
</annotation></semantics></math><em>where:</em>
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mrow><mi>‚àÇ</mi><msub><mi>m</mi><mi>r</mi></msub></mrow><mrow><mi>‚àÇ</mi><mi>Œ∏</mi></mrow></mfrac><mo>=</mo><mi>ùîº</mi><mrow><mo stretchy="true" form="prefix">[</mo><msub><mi>Œ∫</mi><mi>J</mi></msub><msup><mrow><mo stretchy="true" form="prefix">(</mo><mi>Œ±</mi><mo stretchy="true" form="postfix">)</mo></mrow><mi>r</mi></msup><mo>‚ãÖ</mo><msub><mi>s</mi><mi>Œ∏</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>Œ±</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">]</mo></mrow><mo>,</mo><mspace width="1.0em"></mspace><mfrac><mrow><mi>‚àÇ</mi><msub><mi>v</mi><mn>1</mn></msub></mrow><mrow><mi>‚àÇ</mi><mi>Œ∏</mi></mrow></mfrac><mo>=</mo><mi>ùîº</mi><mrow><mo stretchy="true" form="prefix">[</mo><msub><mi>v</mi><mi>J</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>Œ±</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>‚ãÖ</mo><msub><mi>s</mi><mi>Œ∏</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>Œ±</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">]</mo></mrow><mi>.</mi></mrow><annotation encoding="application/x-tex">
\frac{\partial m_r}{\partial \theta} = \mathbb{E}[\kappa_J(\alpha)^r \cdot s_\theta(\alpha)], 
\quad \frac{\partial v_1}{\partial \theta} = \mathbb{E}[v_J(\alpha) \cdot s_\theta(\alpha)].
</annotation></semantics></math></p>
<p>All expectations are computed stably via Gauss-Laguerre quadrature
using the same nodes and weights as for the moment computation
itself.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Compute moments and Jacobian simultaneously</span></span>
<span><span class="va">J</span> <span class="op">&lt;-</span> <span class="fl">50</span></span>
<span><span class="va">a</span> <span class="op">&lt;-</span> <span class="fl">2.0</span></span>
<span><span class="va">b</span> <span class="op">&lt;-</span> <span class="fl">1.0</span></span>
<span></span>
<span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/moments_with_jacobian.html">moments_with_jacobian</a></span><span class="op">(</span>J <span class="op">=</span> <span class="va">J</span>, a <span class="op">=</span> <span class="va">a</span>, b <span class="op">=</span> <span class="va">b</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Marginal Moments:\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Marginal Moments:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"  E[K_J]   = %.6f\n"</span>, <span class="va">result</span><span class="op">$</span><span class="va">mean</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;   E[K_J]   = 6.639693</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"  Var(K_J) = %.6f\n"</span>, <span class="va">result</span><span class="op">$</span><span class="va">var</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Var(K_J) = 12.954502</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"\nJacobian Matrix:\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Jacobian Matrix:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">result</span><span class="op">$</span><span class="va">jacobian</span>, <span class="fl">6</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;           da         db</span></span>
<span><span class="co">#&gt; dM1 2.245605  -4.135585</span></span>
<span><span class="co">#&gt; dV  2.943578 -13.038228</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"\nInterpretation:\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Interpretation:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"  If a increases by 0.1, E[K] increases by ‚âà %.4f\n"</span>, </span>
<span>            <span class="fl">0.1</span> <span class="op">*</span> <span class="va">result</span><span class="op">$</span><span class="va">jacobian</span><span class="op">[</span><span class="st">"dM1"</span>, <span class="st">"da"</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;   If a increases by 0.1, E[K] increases by ‚âà 0.2246</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"  If b increases by 0.1, E[K] decreases by ‚âà %.4f\n"</span>, </span>
<span>            <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="fl">0.1</span> <span class="op">*</span> <span class="va">result</span><span class="op">$</span><span class="va">jacobian</span><span class="op">[</span><span class="st">"dM1"</span>, <span class="st">"db"</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;   If b increases by 0.1, E[K] decreases by ‚âà 0.4136</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="numerical-verification">2.3 Numerical Verification<a class="anchor" aria-label="anchor" href="#numerical-verification"></a>
</h3>
<p>The score-based Jacobian can be verified against central finite
differences:
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mrow><mi>‚àÇ</mi><mi>f</mi></mrow><mrow><mi>‚àÇ</mi><mi>a</mi></mrow></mfrac><mo>‚âà</mo><mfrac><mrow><mi>f</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>a</mi><mo>+</mo><mi>œµ</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>‚àí</mo><mi>f</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>a</mi><mo>‚àí</mo><mi>œµ</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><mrow><mn>2</mn><mi>œµ</mi></mrow></mfrac><mi>.</mi></mrow><annotation encoding="application/x-tex">
\frac{\partial f}{\partial a} \approx 
\frac{f(a + \epsilon) - f(a - \epsilon)}{2\epsilon}.
</annotation></semantics></math></p>
<p>This verification is <strong>secondary</strong> because both methods
use the same quadrature layer, but it confirms the implementation
correctness.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Verify Jacobian against finite differences</span></span>
<span><span class="va">verification</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/verify_jacobian.html">verify_jacobian</a></span><span class="op">(</span>J <span class="op">=</span> <span class="fl">50</span>, a <span class="op">=</span> <span class="fl">2.0</span>, b <span class="op">=</span> <span class="fl">1.0</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Jacobian Verification (J = 50, a = 2.0, b = 1.0)\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Jacobian Verification (J = 50, a = 2.0, b = 1.0)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/strrep.html" class="external-link">strrep</a></span><span class="op">(</span><span class="st">"-"</span>, <span class="fl">50</span><span class="op">)</span>, <span class="st">"\n\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; --------------------------------------------------</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Analytic Jacobian:\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Analytic Jacobian:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">verification</span><span class="op">$</span><span class="va">analytic</span>, <span class="fl">8</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;           da         db</span></span>
<span><span class="co">#&gt; dM1 2.245534  -4.135585</span></span>
<span><span class="co">#&gt; dV  2.944458 -13.038229</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"\nFinite Difference Jacobian:\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Finite Difference Jacobian:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">verification</span><span class="op">$</span><span class="va">numeric</span>, <span class="fl">8</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;           da         db</span></span>
<span><span class="co">#&gt; dM1 2.245520  -4.135585</span></span>
<span><span class="co">#&gt; dV  2.944633 -13.038228</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"\nRelative Error Matrix:\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Relative Error Matrix:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">verification</span><span class="op">$</span><span class="va">rel_error</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;              da    db</span></span>
<span><span class="co">#&gt; dM1 6.31960e-06 0e+00</span></span>
<span><span class="co">#&gt; dV  5.93741e-05 6e-10</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"\nMaximum relative error: %.2e\n"</span>, <span class="va">verification</span><span class="op">$</span><span class="va">max_rel_error</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Maximum relative error: 5.94e-05</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"Verification status: %s\n"</span>, </span>
<span>            <span class="kw">if</span> <span class="op">(</span><span class="va">verification</span><span class="op">$</span><span class="va">pass</span><span class="op">)</span> <span class="st">"PASSED"</span> <span class="kw">else</span> <span class="st">"FAILED"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Verification status: PASSED</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="convergence-analysis">3. Convergence Analysis<a class="anchor" aria-label="anchor" href="#convergence-analysis"></a>
</h2>
<div class="section level3">
<h3 id="local-quadratic-convergence">3.1 Local Quadratic Convergence<a class="anchor" aria-label="anchor" href="#local-quadratic-convergence"></a>
</h3>
<p><strong>Attribution.</strong> The following convergence result is a
standard application of the Newton-Kantorovich theorem; see Ortega &amp;
Rheinboldt (1970, Chapter 10).</p>
<p><strong>Theorem 1</strong> (Local quadratic convergence of
A2-MN).</p>
<p><em>Let
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>Œº</mi><mi>K</mi></msub><mo>,</mo><msubsup><mi>œÉ</mi><mi>K</mi><mn>2</mn></msubsup><mo stretchy="true" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">(\mu_K, \sigma^2_K)</annotation></semantics></math>
be feasible targets satisfying
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Œº</mi><mi>K</mi></msub><mo>&gt;</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">\mu_K &gt; 1</annotation></semantics></math>,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>œÉ</mi><mi>K</mi><mn>2</mn></msubsup><mo>&gt;</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">\sigma^2_K &gt; 0</annotation></semantics></math>,
and suppose there exists
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="true" form="prefix">(</mo><msup><mi>a</mi><mo>*</mo></msup><mo>,</mo><msup><mi>b</mi><mo>*</mo></msup><mo stretchy="true" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">(a^*, b^*)</annotation></semantics></math>
with
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>F</mi><mrow><mo stretchy="true" form="prefix">(</mo><msup><mi>a</mi><mo>*</mo></msup><mo>,</mo><msup><mi>b</mi><mo>*</mo></msup><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">F(a^*, b^*) = 0</annotation></semantics></math>.
If the A1 initializer
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>a</mi><mn>0</mn></msub><mo>,</mo><msub><mi>b</mi><mn>0</mn></msub><mo stretchy="true" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">(a_0, b_0)</annotation></semantics></math>
lies in a neighborhood of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="true" form="prefix">(</mo><msup><mi>a</mi><mo>*</mo></msup><mo>,</mo><msup><mi>b</mi><mo>*</mo></msup><mo stretchy="true" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">(a^*, b^*)</annotation></semantics></math>
where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>F</mi><annotation encoding="application/x-tex">F</annotation></semantics></math>
is continuously differentiable and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>ùêâ</mi><mi>F</mi></msub><annotation encoding="application/x-tex">\mathbf{J}_F</annotation></semantics></math>
is nonsingular, then:</em></p>
<ol style="list-style-type: decimal">
<li><em>The Newton iterates converge to
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="true" form="prefix">(</mo><msup><mi>a</mi><mo>*</mo></msup><mo>,</mo><msup><mi>b</mi><mo>*</mo></msup><mo stretchy="true" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">(a^*, b^*)</annotation></semantics></math>.</em></li>
<li>
<em>Convergence is locally quadratic:</em>
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false" form="postfix">‚à•</mo><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>a</mi><mrow><mi>t</mi><mo>+</mo><mn>1</mn></mrow></msub><mo>,</mo><msub><mi>b</mi><mrow><mi>t</mi><mo>+</mo><mn>1</mn></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>‚àí</mo><mrow><mo stretchy="true" form="prefix">(</mo><msup><mi>a</mi><mo>*</mo></msup><mo>,</mo><msup><mi>b</mi><mo>*</mo></msup><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="false" form="postfix">‚à•</mo><mo>‚â§</mo><mi>C</mi><mo stretchy="false" form="postfix">‚à•</mo><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>a</mi><mi>t</mi></msub><mo>,</mo><msub><mi>b</mi><mi>t</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>‚àí</mo><mrow><mo stretchy="true" form="prefix">(</mo><msup><mi>a</mi><mo>*</mo></msup><mo>,</mo><msup><mi>b</mi><mo>*</mo></msup><mo stretchy="true" form="postfix">)</mo></mrow><msup><mo stretchy="false" form="postfix">‚à•</mo><mn>2</mn></msup><mo>,</mo></mrow><annotation encoding="application/x-tex">
\|(a_{t+1}, b_{t+1}) - (a^*, b^*)\| \leq C \|(a_t, b_t) - (a^*, b^*)\|^2,
</annotation></semantics></math><em>for some constant
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>C</mi><mo>&gt;</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">C &gt; 0</annotation></semantics></math>.</em>
</li>
</ol>
<p><strong>Key conditions for the theorem:</strong></p>
<ul>
<li><p><strong>Smoothness:</strong> The moment functions
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>M</mi><mn>1</mn></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>a</mi><mo>,</mo><mi>b</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">M_1(a, b)</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>a</mi><mo>,</mo><mi>b</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">V(a, b)</annotation></semantics></math>
are smooth in
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="true" form="prefix">(</mo><mi>a</mi><mo>,</mo><mi>b</mi><mo stretchy="true" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">(a, b)</annotation></semantics></math>,
inheriting smoothness from the Gamma density.</p></li>
<li><p><strong>Jacobian invertibility:</strong> The Jacobian is
nonsingular in the parameter region of practical interest (see
Proposition 2 in <code><a href="../articles/theory-overview.html">vignette("theory-overview")</a></code>).</p></li>
<li><p><strong>Basin of attraction:</strong> Proposition 1 below
justifies using A1 as an initializer.</p></li>
</ul>
</div>
<div class="section level3">
<h3 id="why-a1-is-a-good-initializer">3.2 Why A1 is a Good Initializer<a class="anchor" aria-label="anchor" href="#why-a1-is-a-good-initializer"></a>
</h3>
<p><strong>Proposition 1</strong> (A1 initializes in the basin of
attraction).</p>
<p><em>For fixed
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="true" form="prefix">(</mo><mi>a</mi><mo>,</mo><mi>b</mi><mo stretchy="true" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">(a, b)</annotation></semantics></math>
as
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>J</mi><mo>‚Üí</mo><mi>‚àû</mi></mrow><annotation encoding="application/x-tex">J \to \infty</annotation></semantics></math>:</em>
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>M</mi><mn>1</mn></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>a</mi><mo>,</mo><mi>b</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mn>1</mn><mo>+</mo><mfrac><mrow><mi>a</mi><mo>‚ãÖ</mo><mo>log</mo><mi>J</mi></mrow><mi>b</mi></mfrac><mo>+</mo><mi>O</mi><mrow><mo stretchy="true" form="prefix">(</mo><mfrac><mn>1</mn><mi>J</mi></mfrac><mo stretchy="true" form="postfix">)</mo></mrow><mi>.</mi></mrow><annotation encoding="application/x-tex">
M_1(a, b) = 1 + \frac{a \cdot \log J}{b} + O\left(\frac{1}{J}\right).
</annotation></semantics></math></p>
<p><em>In particular, if
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>a</mi><mn>0</mn></msub><mo>,</mo><msub><mi>b</mi><mn>0</mn></msub><mo stretchy="true" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">(a_0, b_0)</annotation></semantics></math>
is the A1 solution for targets
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>Œº</mi><mi>K</mi></msub><mo>,</mo><msubsup><mi>œÉ</mi><mi>K</mi><mn>2</mn></msubsup><mo stretchy="true" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">(\mu_K, \sigma^2_K)</annotation></semantics></math>,
then:</em>
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>M</mi><mn>1</mn></msub><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>a</mi><mn>0</mn></msub><mo>,</mo><msub><mi>b</mi><mn>0</mn></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><msub><mi>Œº</mi><mi>K</mi></msub><mo>+</mo><mi>O</mi><mrow><mo stretchy="true" form="prefix">(</mo><msup><mi>J</mi><mrow><mo>‚àí</mo><mn>1</mn></mrow></msup><mo stretchy="true" form="postfix">)</mo></mrow><mi>.</mi></mrow><annotation encoding="application/x-tex">
M_1(a_0, b_0) = \mu_K + O(J^{-1}).
</annotation></semantics></math></p>
<p><strong>Attribution.</strong> The asymptotic rate
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mrow><mo stretchy="true" form="prefix">(</mo><mn>1</mn><mi>/</mi><mo>log</mo><mi>J</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">O(1/\log J)</annotation></semantics></math>
for the Poisson approximation to
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>K</mi><mi>J</mi></msub><mo stretchy="false" form="prefix">|</mo><mi>Œ±</mi></mrow><annotation encoding="application/x-tex">K_J | \alpha</annotation></semantics></math>
is established in Arratia, Barbour, &amp; Tavar√© (2000). The
moment-level error bounds follow from asymptotic expansion of the
digamma function.</p>
<p><strong>Implication:</strong> Even when A1 is inaccurate at small
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>J</mi><annotation encoding="application/x-tex">J</annotation></semantics></math>,
it typically provides a starting point within the basin of attraction
for Newton‚Äôs method.</p>
</div>
<div class="section level3">
<h3 id="typical-convergence-behavior">3.3 Typical Convergence Behavior<a class="anchor" aria-label="anchor" href="#typical-convergence-behavior"></a>
</h3>
<p>In practice, the A2-MN algorithm converges rapidly:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Demonstrate typical convergence</span></span>
<span><span class="va">J</span> <span class="op">&lt;-</span> <span class="fl">50</span></span>
<span><span class="va">mu_K</span> <span class="op">&lt;-</span> <span class="fl">5</span></span>
<span><span class="va">var_K</span> <span class="op">&lt;-</span> <span class="fl">8</span></span>
<span></span>
<span><span class="co"># Run with verbose output captured</span></span>
<span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/DPprior_a2_newton.html">DPprior_a2_newton</a></span><span class="op">(</span>J <span class="op">=</span> <span class="va">J</span>, mu_K <span class="op">=</span> <span class="va">mu_K</span>, var_K <span class="op">=</span> <span class="va">var_K</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"A2-MN Convergence Summary\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; A2-MN Convergence Summary</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/strrep.html" class="external-link">strrep</a></span><span class="op">(</span><span class="st">"="</span>, <span class="fl">60</span><span class="op">)</span>, <span class="st">"\n\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; ============================================================</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"Target:       E[K] = %.1f, Var(K) = %.1f\n"</span>, <span class="va">mu_K</span>, <span class="va">var_K</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Target:       E[K] = 5.0, Var(K) = 8.0</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"Iterations:   %d\n"</span>, <span class="va">fit</span><span class="op">$</span><span class="va">iterations</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Iterations:   6</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"Termination:  %s\n"</span>, <span class="va">fit</span><span class="op">$</span><span class="va">termination</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Termination:  residual</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"Converged:    %s\n"</span>, <span class="va">fit</span><span class="op">$</span><span class="va">converged</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Converged:    TRUE</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"Final residual: %.2e\n\n"</span>, <span class="va">fit</span><span class="op">$</span><span class="va">fit</span><span class="op">$</span><span class="va">residual</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Final residual: 7.60e-09</span></span>
<span></span>
<span><span class="co"># Display iteration trace</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Iteration History:\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Iteration History:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/strrep.html" class="external-link">strrep</a></span><span class="op">(</span><span class="st">"-"</span>, <span class="fl">80</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; --------------------------------------------------------------------------------</span></span>
<span></span>
<span><span class="va">trace_display</span> <span class="op">&lt;-</span> <span class="va">fit</span><span class="op">$</span><span class="va">trace</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"iter"</span>, <span class="st">"a"</span>, <span class="st">"b"</span>, <span class="st">"M1"</span>, <span class="st">"V"</span>, <span class="st">"residual"</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">trace_display</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Iter"</span>, <span class="st">"a"</span>, <span class="st">"b"</span>, <span class="st">"E[K]"</span>, <span class="st">"Var(K)"</span>, <span class="st">"||F||"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span></span>
<span>  <span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span></span>
<span>    <span class="va">trace_display</span>,</span>
<span>    digits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">6</span>, <span class="fl">6</span>, <span class="fl">6</span>, <span class="fl">6</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>    format <span class="op">=</span> <span class="st">"simple"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  Iter          a          b       E[K]      Var(K)   ||F||</span></span>
<span><span class="co">#&gt; -----  ---------  ---------  ---------  ----------  ------</span></span>
<span><span class="co">#&gt;     1   4.000000   3.912023   4.461351    4.783136    3.26</span></span>
<span><span class="co">#&gt;     2   1.178650   0.911969   4.909046   10.854537    2.86</span></span>
<span><span class="co">#&gt;     3   1.844384   1.455254   4.974913    8.399473    0.40</span></span>
<span><span class="co">#&gt;     4   2.029223   1.599680   4.999187    8.013243    0.01</span></span>
<span><span class="co">#&gt;     5   2.036082   1.605046   4.999999    8.000021    0.00</span></span>
<span><span class="co">#&gt;     6   2.036093   1.605054   5.000000    8.000000    0.00</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="residual-convergence-rate">3.4 Residual Convergence Rate<a class="anchor" aria-label="anchor" href="#residual-convergence-rate"></a>
</h3>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Visualize convergence rate</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">fit</span><span class="op">$</span><span class="va">trace</span><span class="op">)</span> <span class="op">&amp;&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">fit</span><span class="op">$</span><span class="va">trace</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">2</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">trace_plot</span> <span class="op">&lt;-</span> <span class="va">fit</span><span class="op">$</span><span class="va">trace</span><span class="op">[</span><span class="va">fit</span><span class="op">$</span><span class="va">trace</span><span class="op">$</span><span class="va">residual</span> <span class="op">&gt;</span> <span class="fl">0</span>, <span class="op">]</span></span>
<span>  </span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="va">trace_plot</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">iter</span>, y <span class="op">=</span> <span class="va">residual</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">geom_line</span><span class="op">(</span>color <span class="op">=</span> <span class="va">palette_main</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, linewidth <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">geom_point</span><span class="op">(</span>color <span class="op">=</span> <span class="va">palette_main</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, size <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">scale_y_log10</span><span class="op">(</span>labels <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="va"><a href="https://scales.r-lib.org/reference/scientific_format.html" class="external-link">scientific</a></span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">geom_hline</span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">1e-8</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span>, color <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">annotate</span><span class="op">(</span><span class="st">"text"</span>, x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">trace_plot</span><span class="op">$</span><span class="va">iter</span><span class="op">)</span> <span class="op">-</span> <span class="fl">0.5</span>, y <span class="op">=</span> <span class="fl">5e-9</span>, </span>
<span>             label <span class="op">=</span> <span class="st">"Tolerance (10‚Åª‚Å∏)"</span>, color <span class="op">=</span> <span class="st">"red"</span>, hjust <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">labs</span><span class="op">(</span></span>
<span>      x <span class="op">=</span> <span class="st">"Iteration"</span>,</span>
<span>      y <span class="op">=</span> <span class="st">"Residual ||F|| (log scale)"</span>,</span>
<span>      title <span class="op">=</span> <span class="st">"A2-MN Convergence Rate"</span>,</span>
<span>      subtitle <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"J = %d, target (Œº_K, œÉ¬≤_K) = (%.0f, %.0f)"</span>, <span class="va">J</span>, <span class="va">mu_K</span>, <span class="va">var_K</span><span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">theme_minimal</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="theory-newton_files/figure-html/convergence-rate-1.png" class="r-plt" alt="Quadratic convergence: residual decreases rapidly with each iteration." width="85%"><p class="caption">
Quadratic convergence: residual decreases rapidly with each iteration.
</p>
</div>
</div>
</div>
<div class="section level2">
<h2 id="numerical-safeguards">4. Numerical Safeguards<a class="anchor" aria-label="anchor" href="#numerical-safeguards"></a>
</h2>
<p>The A2-MN implementation includes several safeguards to ensure robust
convergence across diverse input scenarios.</p>
<div class="section level3">
<h3 id="log-parameterization-for-positivity">4.1 Log-Parameterization for Positivity<a class="anchor" aria-label="anchor" href="#log-parameterization-for-positivity"></a>
</h3>
<p>Since
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="true" form="prefix">(</mo><mi>a</mi><mo>,</mo><mi>b</mi><mo stretchy="true" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">(a, b)</annotation></semantics></math>
must be strictly positive, we parameterize the problem in log-space:
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Œ∑</mi><mo>=</mo><mrow><mo stretchy="true" form="prefix">(</mo><mo>log</mo><mi>a</mi><mo>,</mo><mo>log</mo><mi>b</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>‚àà</mo><msup><mi>‚Ñù</mi><mn>2</mn></msup><mi>.</mi></mrow><annotation encoding="application/x-tex">
\eta = (\log a, \log b) \in \mathbb{R}^2.
</annotation></semantics></math></p>
<p>The Newton update becomes:
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Œ∑</mi><mrow><mi>t</mi><mo>+</mo><mn>1</mn></mrow></msub><mo>=</mo><msub><mi>Œ∑</mi><mi>t</mi></msub><mo>‚àí</mo><msub><mi>Œª</mi><mi>t</mi></msub><mspace width="0.167em"></mspace><msubsup><mi>ùêâ</mi><mo>log</mo><mrow><mo>‚àí</mo><mn>1</mn></mrow></msubsup><mo>‚ãÖ</mo><mi>F</mi><mrow><mo stretchy="true" form="prefix">(</mo><msup><mi>e</mi><msub><mi>Œ∑</mi><mi>t</mi></msub></msup><mo stretchy="true" form="postfix">)</mo></mrow><mo>,</mo></mrow><annotation encoding="application/x-tex">
\eta_{t+1} = \eta_t - \lambda_t \, \mathbf{J}_{\log}^{-1} \cdot F(e^{\eta_t}),
</annotation></semantics></math> where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>ùêâ</mi><mo>log</mo></msub><mo>=</mo><msub><mi>ùêâ</mi><mi>F</mi></msub><mo>‚ãÖ</mo><mtext mathvariant="normal">diag</mtext><mrow><mo stretchy="true" form="prefix">(</mo><mi>a</mi><mo>,</mo><mi>b</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\mathbf{J}_{\log} = \mathbf{J}_F \cdot \text{diag}(a, b)</annotation></semantics></math>
is the chain-rule adjusted Jacobian.</p>
<p><strong>Benefit:</strong> No explicit positivity constraints needed;
any
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Œ∑</mi><mo>‚àà</mo><msup><mi>‚Ñù</mi><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">\eta \in \mathbb{R}^2</annotation></semantics></math>
yields valid
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mrow><mo stretchy="true" form="prefix">(</mo><mi>a</mi><mo>,</mo><mi>b</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>&gt;</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">(a, b) &gt; 0</annotation></semantics></math>.</p>
</div>
<div class="section level3">
<h3 id="damped-newton-with-backtracking">4.2 Damped Newton with Backtracking<a class="anchor" aria-label="anchor" href="#damped-newton-with-backtracking"></a>
</h3>
<p>To ensure global convergence from the A1 initialization, we employ
<strong>backtracking line search</strong>:</p>
<ol style="list-style-type: decimal">
<li>Compute the full Newton step
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Œî</mi><mi>Œ∑</mi></mrow><annotation encoding="application/x-tex">\Delta \eta</annotation></semantics></math>
</li>
<li>Set
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Œª</mi><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">\lambda = 1</annotation></semantics></math>
</li>
<li>While
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false" form="postfix">‚à•</mo><mi>F</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>Œ∑</mi><mo>+</mo><mi>Œª</mi><mi>Œî</mi><mi>Œ∑</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="false" form="postfix">‚à•</mo><mo>&gt;</mo><mrow><mo stretchy="true" form="prefix">(</mo><mn>1</mn><mo>‚àí</mo><mn>0.5</mn><mi>Œª</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="false" form="postfix">‚à•</mo><mi>F</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>Œ∑</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="false" form="postfix">‚à•</mo></mrow><annotation encoding="application/x-tex">\|F(\eta + \lambda \Delta\eta)\| &gt; (1 - 0.5\lambda)\|F(\eta)\|</annotation></semantics></math>:
<ul>
<li>Halve the step size:
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Œª</mi><mo>‚Üê</mo><mi>Œª</mi><mi>/</mi><mn>2</mn></mrow><annotation encoding="application/x-tex">\lambda \leftarrow \lambda / 2</annotation></semantics></math>
</li>
<li>If
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Œª</mi><mo>&lt;</mo><msup><mn>10</mn><mrow><mo>‚àí</mo><mn>8</mn></mrow></msup></mrow><annotation encoding="application/x-tex">\lambda &lt; 10^{-8}</annotation></semantics></math>:
trigger fallback</li>
</ul>
</li>
</ol>
<p><strong>Attribution.</strong> Damped Newton methods are standard in
nonlinear optimization; see Nocedal &amp; Wright (2006, Chapter 3).</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Demonstrate that damping is rarely needed for typical targets</span></span>
<span><span class="va">test_cases</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>J <span class="op">=</span> <span class="fl">30</span>, mu_K <span class="op">=</span> <span class="fl">3</span>, var_K <span class="op">=</span> <span class="fl">5</span>, desc <span class="op">=</span> <span class="st">"Small J, low K"</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>J <span class="op">=</span> <span class="fl">50</span>, mu_K <span class="op">=</span> <span class="fl">5</span>, var_K <span class="op">=</span> <span class="fl">8</span>, desc <span class="op">=</span> <span class="st">"Typical case"</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>J <span class="op">=</span> <span class="fl">100</span>, mu_K <span class="op">=</span> <span class="fl">10</span>, var_K <span class="op">=</span> <span class="fl">15</span>, desc <span class="op">=</span> <span class="st">"Moderate J, higher K"</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>J <span class="op">=</span> <span class="fl">50</span>, mu_K <span class="op">=</span> <span class="fl">3</span>, var_K <span class="op">=</span> <span class="fl">10</span>, desc <span class="op">=</span> <span class="st">"High VIF (challenging)"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Convergence Across Different Scenarios\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Convergence Across Different Scenarios</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/strrep.html" class="external-link">strrep</a></span><span class="op">(</span><span class="st">"="</span>, <span class="fl">70</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; ======================================================================</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"%-25s %6s %6s %6s %10s %10s\n"</span>, </span>
<span>            <span class="st">"Scenario"</span>, <span class="st">"J"</span>, <span class="st">"Œº_K"</span>, <span class="st">"œÉ¬≤_K"</span>, <span class="st">"Iterations"</span>, <span class="st">"Residual"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Scenario                       J   Œº_K œÉ¬≤_K Iterations   Residual</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/strrep.html" class="external-link">strrep</a></span><span class="op">(</span><span class="st">"-"</span>, <span class="fl">70</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; ----------------------------------------------------------------------</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">tc</span> <span class="kw">in</span> <span class="va">test_cases</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/DPprior_a2_newton.html">DPprior_a2_newton</a></span><span class="op">(</span><span class="va">tc</span><span class="op">$</span><span class="va">J</span>, <span class="va">tc</span><span class="op">$</span><span class="va">mu_K</span>, <span class="va">tc</span><span class="op">$</span><span class="va">var_K</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"%-25s %6d %6.0f %6.0f %10d %10.2e\n"</span>,</span>
<span>              <span class="va">tc</span><span class="op">$</span><span class="va">desc</span>, <span class="va">tc</span><span class="op">$</span><span class="va">J</span>, <span class="va">tc</span><span class="op">$</span><span class="va">mu_K</span>, <span class="va">tc</span><span class="op">$</span><span class="va">var_K</span>, </span>
<span>              <span class="va">fit</span><span class="op">$</span><span class="va">iterations</span>, <span class="va">fit</span><span class="op">$</span><span class="va">fit</span><span class="op">$</span><span class="va">residual</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt; Small J, low K                30      3      5         10   9.09e-10</span></span>
<span><span class="co">#&gt; Typical case                  50      5      8          6   7.60e-09</span></span>
<span><span class="co">#&gt; Moderate J, higher K         100     10     15          5   3.12e-10</span></span>
<span><span class="co">#&gt; High VIF (challenging)        50      3     10         16   4.38e-09</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="jacobian-regularization">4.3 Jacobian Regularization<a class="anchor" aria-label="anchor" href="#jacobian-regularization"></a>
</h3>
<p>If the Jacobian becomes near-singular
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mrow><mo stretchy="true" form="prefix">|</mo><mo>det</mo><mrow><mo stretchy="true" form="prefix">(</mo><mi>ùêâ</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">|</mo></mrow><mo>&lt;</mo><msup><mn>10</mn><mrow><mo>‚àí</mo><mn>12</mn></mrow></msup></mrow><annotation encoding="application/x-tex">|\det(\mathbf{J})| &lt; 10^{-12}</annotation></semantics></math>),
the algorithm switches to a <strong>gradient descent fallback</strong>:
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Œî</mi><mi>Œ∑</mi><mo>=</mo><mo>‚àí</mo><mn>0.1</mn><mo>‚ãÖ</mo><mi>F</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>Œ∑</mi><mo stretchy="true" form="postfix">)</mo></mrow><mi>.</mi></mrow><annotation encoding="application/x-tex">
\Delta \eta = -0.1 \cdot F(\eta).
</annotation></semantics></math></p>
<p>This prevents numerical instability while still making progress
toward the solution.</p>
</div>
<div class="section level3">
<h3 id="nelder-mead-fallback">4.4 Nelder-Mead Fallback<a class="anchor" aria-label="anchor" href="#nelder-mead-fallback"></a>
</h3>
<p>If Newton fails to converge after the maximum number of iterations,
the algorithm can optionally invoke Nelder-Mead optimization as a robust
fallback:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># The Nelder-Mead fallback is enabled by default:</span></span>
<span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/DPprior_a2_newton.html">DPprior_a2_newton</a></span><span class="op">(</span>J <span class="op">=</span> <span class="fl">50</span>, mu_K <span class="op">=</span> <span class="fl">5</span>, var_K <span class="op">=</span> <span class="fl">8</span>,</span>
<span>                         use_fallback <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>  <span class="co"># Default</span></span>
<span></span>
<span><span class="co"># It can be disabled if you want Newton-only:</span></span>
<span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/DPprior_a2_newton.html">DPprior_a2_newton</a></span><span class="op">(</span>J <span class="op">=</span> <span class="fl">50</span>, mu_K <span class="op">=</span> <span class="fl">5</span>, var_K <span class="op">=</span> <span class="fl">8</span>,</span>
<span>                         use_fallback <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="feasibility-pre-screening">4.5 Feasibility Pre-Screening<a class="anchor" aria-label="anchor" href="#feasibility-pre-screening"></a>
</h3>
<p>Before optimization, the algorithm enforces basic necessary
conditions:</p>
<ul>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><mo>&lt;</mo><msub><mi>Œº</mi><mi>K</mi></msub><mo>&lt;</mo><mi>J</mi></mrow><annotation encoding="application/x-tex">1 &lt; \mu_K &lt; J</annotation></semantics></math>
(mean must be achievable)</li>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn><mo>&lt;</mo><msubsup><mi>œÉ</mi><mi>K</mi><mn>2</mn></msubsup><mo>&lt;</mo><msup><mrow><mo stretchy="true" form="prefix">(</mo><mi>J</mi><mo>‚àí</mo><mn>1</mn><mo stretchy="true" form="postfix">)</mo></mrow><mn>2</mn></msup><mi>/</mi><mn>4</mn></mrow><annotation encoding="application/x-tex">0 &lt; \sigma^2_K &lt; (J-1)^2/4</annotation></semantics></math>
(Popoviciu variance bound)</li>
</ul>
<p>These conditions are <strong>necessary but not sufficient</strong>
for feasibility under the Gamma-DP model.</p>
</div>
</div>
<div class="section level2">
<h2 id="a1-vs--a2-comparison">5. A1 vs.¬†A2 Comparison<a class="anchor" aria-label="anchor" href="#a1-vs--a2-comparison"></a>
</h2>
<div class="section level3">
<h3 id="systematic-error-analysis">5.1 Systematic Error Analysis<a class="anchor" aria-label="anchor" href="#systematic-error-analysis"></a>
</h3>
<p>The A1 closed-form approximation introduces systematic errors that
the A2 refinement corrects:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Systematic comparison across parameter grid</span></span>
<span><span class="va">comparison_grid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html" class="external-link">expand.grid</a></span><span class="op">(</span></span>
<span>  J <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">25</span>, <span class="fl">50</span>, <span class="fl">100</span><span class="op">)</span>,</span>
<span>  mu_K <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">10</span><span class="op">)</span>,</span>
<span>  vif <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1.5</span>, <span class="fl">2.5</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">comparison_grid</span><span class="op">$</span><span class="va">var_K</span> <span class="op">&lt;-</span> <span class="va">comparison_grid</span><span class="op">$</span><span class="va">vif</span> <span class="op">*</span> <span class="op">(</span><span class="va">comparison_grid</span><span class="op">$</span><span class="va">mu_K</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Filter valid cases</span></span>
<span><span class="va">comparison_grid</span> <span class="op">&lt;-</span> <span class="va">comparison_grid</span><span class="op">[</span><span class="va">comparison_grid</span><span class="op">$</span><span class="va">mu_K</span> <span class="op">&lt;</span> <span class="va">comparison_grid</span><span class="op">$</span><span class="va">J</span>, <span class="op">]</span></span>
<span></span>
<span><span class="va">results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">comparison_grid</span><span class="op">)</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">J</span> <span class="op">&lt;-</span> <span class="va">comparison_grid</span><span class="op">$</span><span class="va">J</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span>  <span class="va">mu_K</span> <span class="op">&lt;-</span> <span class="va">comparison_grid</span><span class="op">$</span><span class="va">mu_K</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span>  <span class="va">var_K</span> <span class="op">&lt;-</span> <span class="va">comparison_grid</span><span class="op">$</span><span class="va">var_K</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span>  </span>
<span>  <span class="va">comp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/compare_a1_a2.html">compare_a1_a2</a></span><span class="op">(</span>J <span class="op">=</span> <span class="va">J</span>, mu_K <span class="op">=</span> <span class="va">mu_K</span>, var_K <span class="op">=</span> <span class="va">var_K</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>    J <span class="op">=</span> <span class="va">J</span>,</span>
<span>    mu_K <span class="op">=</span> <span class="va">mu_K</span>,</span>
<span>    var_K <span class="op">=</span> <span class="va">var_K</span>,</span>
<span>    a1_mean_err <span class="op">=</span> <span class="fl">100</span> <span class="op">*</span> <span class="op">(</span><span class="va">comp</span><span class="op">$</span><span class="va">a1</span><span class="op">$</span><span class="va">mean</span> <span class="op">-</span> <span class="va">mu_K</span><span class="op">)</span> <span class="op">/</span> <span class="va">mu_K</span>,</span>
<span>    a1_var_err <span class="op">=</span> <span class="fl">100</span> <span class="op">*</span> <span class="op">(</span><span class="va">comp</span><span class="op">$</span><span class="va">a1</span><span class="op">$</span><span class="va">var</span> <span class="op">-</span> <span class="va">var_K</span><span class="op">)</span> <span class="op">/</span> <span class="va">var_K</span>,</span>
<span>    a2_residual <span class="op">=</span> <span class="va">comp</span><span class="op">$</span><span class="va">a2</span><span class="op">$</span><span class="va">residual</span>,</span>
<span>    improvement <span class="op">=</span> <span class="va">comp</span><span class="op">$</span><span class="va">improvement_ratio</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"A1 vs A2: Moment Matching Accuracy\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; A1 vs A2: Moment Matching Accuracy</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/strrep.html" class="external-link">strrep</a></span><span class="op">(</span><span class="st">"="</span>, <span class="fl">80</span><span class="op">)</span>, <span class="st">"\n\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; ================================================================================</span></span>
<span></span>
<span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span></span>
<span>  <span class="va">results</span>,</span>
<span>  digits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">0</span><span class="op">)</span>,</span>
<span>  col.names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"J"</span>, <span class="st">"Œº_K"</span>, <span class="st">"œÉ¬≤_K"</span>, </span>
<span>                <span class="st">"A1 Mean Err %"</span>, <span class="st">"A1 Var Err %"</span>, </span>
<span>                <span class="st">"A2 Residual"</span>, <span class="st">"Improvement"</span><span class="op">)</span>,</span>
<span>  caption <span class="op">=</span> <span class="st">"A1 errors and A2 correction across scenarios"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<table class="table">
<caption>A1 errors and A2 correction across scenarios</caption>
<colgroup>
<col width="6%">
<col width="6%">
<col width="7%">
<col width="21%">
<col width="20%">
<col width="18%">
<col width="20%">
</colgroup>
<thead><tr class="header">
<th align="right">J</th>
<th align="right">Œº_K</th>
<th align="right">œÉ¬≤_K</th>
<th align="right">A1 Mean Err %</th>
<th align="right">A1 Var Err %</th>
<th align="right">A2 Residual</th>
<th align="right">Improvement</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="right">25</td>
<td align="right">5</td>
<td align="right">6.0</td>
<td align="right">-14.6</td>
<td align="right">-46.3</td>
<td align="right">0</td>
<td align="right">9.662020e+08</td>
</tr>
<tr class="even">
<td align="right">50</td>
<td align="right">5</td>
<td align="right">6.0</td>
<td align="right">-9.8</td>
<td align="right">-35.2</td>
<td align="right">0</td>
<td align="right">6.043385e+08</td>
</tr>
<tr class="odd">
<td align="right">100</td>
<td align="right">5</td>
<td align="right">6.0</td>
<td align="right">-6.6</td>
<td align="right">-27.2</td>
<td align="right">0</td>
<td align="right">1.170285e+12</td>
</tr>
<tr class="even">
<td align="right">25</td>
<td align="right">10</td>
<td align="right">13.5</td>
<td align="right">-31.6</td>
<td align="right">-66.0</td>
<td align="right">0</td>
<td align="right">9.778035e+12</td>
</tr>
<tr class="odd">
<td align="right">50</td>
<td align="right">10</td>
<td align="right">13.5</td>
<td align="right">-23.6</td>
<td align="right">-54.0</td>
<td align="right">0</td>
<td align="right">2.208491e+12</td>
</tr>
<tr class="even">
<td align="right">100</td>
<td align="right">10</td>
<td align="right">13.5</td>
<td align="right">-17.9</td>
<td align="right">-44.2</td>
<td align="right">0</td>
<td align="right">2.361792e+10</td>
</tr>
<tr class="odd">
<td align="right">25</td>
<td align="right">5</td>
<td align="right">10.0</td>
<td align="right">-16.9</td>
<td align="right">-55.5</td>
<td align="right">0</td>
<td align="right">2.181640e+09</td>
</tr>
<tr class="even">
<td align="right">50</td>
<td align="right">5</td>
<td align="right">10.0</td>
<td align="right">-11.7</td>
<td align="right">-43.8</td>
<td align="right">0</td>
<td align="right">1.121455e+10</td>
</tr>
<tr class="odd">
<td align="right">100</td>
<td align="right">5</td>
<td align="right">10.0</td>
<td align="right">-8.3</td>
<td align="right">-34.7</td>
<td align="right">0</td>
<td align="right">1.722180e+09</td>
</tr>
<tr class="even">
<td align="right">25</td>
<td align="right">10</td>
<td align="right">22.5</td>
<td align="right">-32.8</td>
<td align="right">-73.3</td>
<td align="right">0</td>
<td align="right">4.426826e+11</td>
</tr>
<tr class="odd">
<td align="right">50</td>
<td align="right">10</td>
<td align="right">22.5</td>
<td align="right">-24.6</td>
<td align="right">-61.7</td>
<td align="right">0</td>
<td align="right">1.342414e+12</td>
</tr>
<tr class="even">
<td align="right">100</td>
<td align="right">10</td>
<td align="right">22.5</td>
<td align="right">-18.8</td>
<td align="right">-51.6</td>
<td align="right">0</td>
<td align="right">5.514431e+09</td>
</tr>
</tbody>
</table>
</div>
<div class="section level3">
<h3 id="representative-comparison">5.2 Representative Comparison<a class="anchor" aria-label="anchor" href="#representative-comparison"></a>
</h3>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Detailed comparison for a representative case</span></span>
<span><span class="va">J</span> <span class="op">&lt;-</span> <span class="fl">50</span></span>
<span><span class="va">mu_K</span> <span class="op">&lt;-</span> <span class="fl">5</span></span>
<span><span class="va">var_K</span> <span class="op">&lt;-</span> <span class="fl">8</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"Detailed Comparison: J = %d, Œº_K = %.0f, œÉ¬≤_K = %.0f\n"</span>, <span class="va">J</span>, <span class="va">mu_K</span>, <span class="va">var_K</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Detailed Comparison: J = 50, Œº_K = 5, œÉ¬≤_K = 8</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/strrep.html" class="external-link">strrep</a></span><span class="op">(</span><span class="st">"="</span>, <span class="fl">60</span><span class="op">)</span>, <span class="st">"\n\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; ============================================================</span></span>
<span></span>
<span><span class="co"># A1 solution</span></span>
<span><span class="va">a1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/DPprior_a1.html">DPprior_a1</a></span><span class="op">(</span>J <span class="op">=</span> <span class="va">J</span>, mu_K <span class="op">=</span> <span class="va">mu_K</span>, var_K <span class="op">=</span> <span class="va">var_K</span><span class="op">)</span></span>
<span><span class="va">a1_mom</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/exact_K_moments.html">exact_K_moments</a></span><span class="op">(</span><span class="va">J</span>, <span class="va">a1</span><span class="op">$</span><span class="va">a</span>, <span class="va">a1</span><span class="op">$</span><span class="va">b</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># A2 solution</span></span>
<span><span class="va">a2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/DPprior_a2_newton.html">DPprior_a2_newton</a></span><span class="op">(</span>J <span class="op">=</span> <span class="va">J</span>, mu_K <span class="op">=</span> <span class="va">mu_K</span>, var_K <span class="op">=</span> <span class="va">var_K</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Gamma Hyperparameters:\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Gamma Hyperparameters:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"  A1: Gamma(a = %.6f, b = %.6f)\n"</span>, <span class="va">a1</span><span class="op">$</span><span class="va">a</span>, <span class="va">a1</span><span class="op">$</span><span class="va">b</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;   A1: Gamma(a = 4.000000, b = 3.912023)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"  A2: Gamma(a = %.6f, b = %.6f)\n"</span>, <span class="va">a2</span><span class="op">$</span><span class="va">a</span>, <span class="va">a2</span><span class="op">$</span><span class="va">b</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;   A2: Gamma(a = 2.036093, b = 1.605054)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"\nMoment Matching:\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Moment Matching:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"  %-20s %12s %12s %12s\n"</span>, <span class="st">""</span>, <span class="st">"Target"</span>, <span class="st">"A1"</span>, <span class="st">"A2"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;                              Target           A1           A2</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"  %-20s %12.4f %12.4f %12.10f\n"</span>, <span class="st">"E[K]"</span>, <span class="va">mu_K</span>, <span class="va">a1_mom</span><span class="op">$</span><span class="va">mean</span>, <span class="va">a2</span><span class="op">$</span><span class="va">fit</span><span class="op">$</span><span class="va">mu_K</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;   E[K]                       5.0000       4.4614 4.9999999992</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"  %-20s %12.4f %12.4f %12.10f\n"</span>, <span class="st">"Var(K)"</span>, <span class="va">var_K</span>, <span class="va">a1_mom</span><span class="op">$</span><span class="va">var</span>, <span class="va">a2</span><span class="op">$</span><span class="va">fit</span><span class="op">$</span><span class="va">var_K</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Var(K)                     8.0000       4.7831 8.0000000076</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"\nResidual ||F||:\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Residual ||F||:</span></span>
<span><span class="va">a1_residual</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="op">(</span><span class="va">a1_mom</span><span class="op">$</span><span class="va">mean</span> <span class="op">-</span> <span class="va">mu_K</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span> <span class="op">+</span> <span class="op">(</span><span class="va">a1_mom</span><span class="op">$</span><span class="va">var</span> <span class="op">-</span> <span class="va">var_K</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"  A1: %.6f\n"</span>, <span class="va">a1_residual</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;   A1: 3.261649</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"  A2: %.2e\n"</span>, <span class="va">a2</span><span class="op">$</span><span class="va">fit</span><span class="op">$</span><span class="va">residual</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;   A2: 7.60e-09</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"  Improvement: %.0fx more accurate\n"</span>, <span class="va">a1_residual</span> <span class="op">/</span> <span class="va">a2</span><span class="op">$</span><span class="va">fit</span><span class="op">$</span><span class="va">residual</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Improvement: 429143906x more accurate</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="visualizing-the-improvement">5.3 Visualizing the Improvement<a class="anchor" aria-label="anchor" href="#visualizing-the-improvement"></a>
</h3>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Compare the induced K distributions</span></span>
<span><span class="va">J</span> <span class="op">&lt;-</span> <span class="fl">50</span></span>
<span><span class="va">mu_K</span> <span class="op">&lt;-</span> <span class="fl">5</span></span>
<span><span class="va">var_K</span> <span class="op">&lt;-</span> <span class="fl">8</span></span>
<span></span>
<span><span class="va">a1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/DPprior_a1.html">DPprior_a1</a></span><span class="op">(</span>J <span class="op">=</span> <span class="va">J</span>, mu_K <span class="op">=</span> <span class="va">mu_K</span>, var_K <span class="op">=</span> <span class="va">var_K</span><span class="op">)</span></span>
<span><span class="va">a2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/DPprior_a2_newton.html">DPprior_a2_newton</a></span><span class="op">(</span>J <span class="op">=</span> <span class="va">J</span>, mu_K <span class="op">=</span> <span class="va">mu_K</span>, var_K <span class="op">=</span> <span class="va">var_K</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">logS</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/compute_log_stirling.html">compute_log_stirling</a></span><span class="op">(</span><span class="va">J</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Compute PMFs</span></span>
<span><span class="va">pmf_a1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/pmf_K_marginal.html">pmf_K_marginal</a></span><span class="op">(</span><span class="va">J</span>, <span class="va">a1</span><span class="op">$</span><span class="va">a</span>, <span class="va">a1</span><span class="op">$</span><span class="va">b</span>, logS <span class="op">=</span> <span class="va">logS</span><span class="op">)</span></span>
<span><span class="va">pmf_a2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/pmf_K_marginal.html">pmf_K_marginal</a></span><span class="op">(</span><span class="va">J</span>, <span class="va">a2</span><span class="op">$</span><span class="va">a</span>, <span class="va">a2</span><span class="op">$</span><span class="va">b</span>, logS <span class="op">=</span> <span class="va">logS</span><span class="op">)</span></span>
<span></span>
<span><span class="va">k_range</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="fl">15</span></span>
<span><span class="va">pmf_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  k <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">k_range</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>  pmf <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">pmf_a1</span><span class="op">[</span><span class="va">k_range</span> <span class="op">+</span> <span class="fl">1</span><span class="op">]</span>, <span class="va">pmf_a2</span><span class="op">[</span><span class="va">k_range</span> <span class="op">+</span> <span class="fl">1</span><span class="op">]</span><span class="op">)</span>,</span>
<span>  Method <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"A1 (closed-form)"</span>, <span class="st">"A2 (Newton refinement)"</span><span class="op">)</span>, each <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">k_range</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">pmf_df</span><span class="op">$</span><span class="va">Method</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">pmf_df</span><span class="op">$</span><span class="va">Method</span>, </span>
<span>                        levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"A1 (closed-form)"</span>, <span class="st">"A2 (Newton refinement)"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Compute achieved moments for annotation</span></span>
<span><span class="va">a1_mom</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/exact_K_moments.html">exact_K_moments</a></span><span class="op">(</span><span class="va">J</span>, <span class="va">a1</span><span class="op">$</span><span class="va">a</span>, <span class="va">a1</span><span class="op">$</span><span class="va">b</span><span class="op">)</span></span>
<span><span class="va">a2_mom</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/exact_K_moments.html">exact_K_moments</a></span><span class="op">(</span><span class="va">J</span>, <span class="va">a2</span><span class="op">$</span><span class="va">a</span>, <span class="va">a2</span><span class="op">$</span><span class="va">b</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="va">pmf_df</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">k</span>, y <span class="op">=</span> <span class="va">pmf</span>, fill <span class="op">=</span> <span class="va">Method</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_col</span><span class="op">(</span>position <span class="op">=</span> <span class="fu">position_dodge</span><span class="op">(</span>width <span class="op">=</span> <span class="fl">0.7</span><span class="op">)</span>, width <span class="op">=</span> <span class="fl">0.6</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_vline</span><span class="op">(</span>xintercept <span class="op">=</span> <span class="va">mu_K</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span>, color <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">annotate</span><span class="op">(</span><span class="st">"text"</span>, x <span class="op">=</span> <span class="va">mu_K</span> <span class="op">+</span> <span class="fl">0.3</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">pmf_df</span><span class="op">$</span><span class="va">pmf</span><span class="op">)</span> <span class="op">*</span> <span class="fl">0.95</span>, </span>
<span>           label <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"Target Œº_K = %.0f"</span>, <span class="va">mu_K</span><span class="op">)</span>, hjust <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">palette_main</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">palette_main</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html" class="external-link">expression</a></span><span class="op">(</span><span class="va">K</span><span class="op">[</span><span class="va">J</span><span class="op">]</span><span class="op">)</span>,</span>
<span>    y <span class="op">=</span> <span class="st">"Probability"</span>,</span>
<span>    title <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html" class="external-link">expression</a></span><span class="op">(</span><span class="st">"Prior Distribution of "</span> <span class="op">*</span> <span class="va">K</span><span class="op">[</span><span class="va">J</span><span class="op">]</span> <span class="op">*</span> <span class="st">": A1 vs A2"</span><span class="op">)</span>,</span>
<span>    subtitle <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"A1: E[K]=%.2f, Var=%.2f | A2: E[K]=%.4f, Var=%.4f | Target: (%.0f, %.0f)"</span>,</span>
<span>                       <span class="va">a1_mom</span><span class="op">$</span><span class="va">mean</span>, <span class="va">a1_mom</span><span class="op">$</span><span class="va">var</span>, <span class="va">a2_mom</span><span class="op">$</span><span class="va">mean</span>, <span class="va">a2_mom</span><span class="op">$</span><span class="va">var</span>, <span class="va">mu_K</span>, <span class="va">var_K</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_minimal</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span>, legend.title <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="theory-newton_files/figure-html/a1-a2-visual-1.png" class="r-plt" alt="Comparison of K_J distributions under A1 and A2 hyperpriors." width="85%"><p class="caption">
Comparison of K_J distributions under A1 and A2 hyperpriors.
</p>
</div>
</div>
<div class="section level3">
<h3 id="computational-cost">5.4 Computational Cost<a class="anchor" aria-label="anchor" href="#computational-cost"></a>
</h3>
<p>The A2 refinement is remarkably efficient:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Benchmark A1 vs A2</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/joshuaulrich/microbenchmark/" class="external-link">microbenchmark</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">J</span> <span class="op">&lt;-</span> <span class="fl">50</span></span>
<span><span class="va">mu_K</span> <span class="op">&lt;-</span> <span class="fl">5</span></span>
<span><span class="va">var_K</span> <span class="op">&lt;-</span> <span class="fl">8</span></span>
<span></span>
<span><span class="co"># Suppress output during benchmarking</span></span>
<span><span class="va">bench</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html" class="external-link">microbenchmark</a></span><span class="op">(</span></span>
<span>  A1 <span class="op">=</span> <span class="fu"><a href="../reference/DPprior_a1.html">DPprior_a1</a></span><span class="op">(</span>J <span class="op">=</span> <span class="va">J</span>, mu_K <span class="op">=</span> <span class="va">mu_K</span>, var_K <span class="op">=</span> <span class="va">var_K</span><span class="op">)</span>,</span>
<span>  A2 <span class="op">=</span> <span class="fu"><a href="../reference/DPprior_a2_newton.html">DPprior_a2_newton</a></span><span class="op">(</span>J <span class="op">=</span> <span class="va">J</span>, mu_K <span class="op">=</span> <span class="va">mu_K</span>, var_K <span class="op">=</span> <span class="va">var_K</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>,</span>
<span>  times <span class="op">=</span> <span class="fl">20</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Computational Cost Comparison\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Computational Cost Comparison</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/strrep.html" class="external-link">strrep</a></span><span class="op">(</span><span class="st">"-"</span>, <span class="fl">50</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; --------------------------------------------------</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">bench</span><span class="op">)</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"expr"</span>, <span class="st">"mean"</span>, <span class="st">"median"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt;   expr        mean     median</span></span>
<span><span class="co">#&gt; 1   A1    34.50895    28.1765</span></span>
<span><span class="co">#&gt; 2   A2 17928.18665 17482.7510</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"\nNote: A2 takes ~10x longer than A1 but achieves ~10‚Å∂x better accuracy.\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Note: A2 takes ~10x longer than A1 but achieves ~10‚Å∂x better accuracy.</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"The added cost (a few milliseconds) is negligible for most applications.\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; The added cost (a few milliseconds) is negligible for most applications.</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="summary">6. Summary<a class="anchor" aria-label="anchor" href="#summary"></a>
</h2>
<p>This vignette has provided a rigorous treatment of the A2 Newton
algorithm:</p>
<ol style="list-style-type: decimal">
<li><p><strong>Problem formulation:</strong> Exact moment matching as 2D
root-finding</p></li>
<li><p><strong>Score-based Jacobian:</strong> Analytically derived using
score function identities, avoiding finite differences</p></li>
<li><p><strong>Convergence theory:</strong> Local quadratic convergence
when initialized from the A1 solution (Theorem 1)</p></li>
<li><p><strong>Numerical safeguards:</strong> Log-parameterization,
damped Newton with backtracking, Jacobian regularization, and
Nelder-Mead fallback</p></li>
<li><p><strong>Error reduction:</strong> A2 reduces moment-matching
residuals by factors of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msup><mn>10</mn><mn>6</mn></msup><annotation encoding="application/x-tex">10^6</annotation></semantics></math>
or more compared to A1</p></li>
</ol>
<div class="section level3">
<h3 id="key-functions">Key Functions<a class="anchor" aria-label="anchor" href="#key-functions"></a>
</h3>
<table class="table">
<colgroup>
<col width="43%">
<col width="56%">
</colgroup>
<thead><tr class="header">
<th>Function</th>
<th>Description</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code><a href="../reference/DPprior_a2_newton.html">DPprior_a2_newton()</a></code></td>
<td>Main A2-MN solver</td>
</tr>
<tr class="even">
<td><code><a href="../reference/moments_with_jacobian.html">moments_with_jacobian()</a></code></td>
<td>Compute moments and Jacobian simultaneously</td>
</tr>
<tr class="odd">
<td><code><a href="../reference/compare_a1_a2.html">compare_a1_a2()</a></code></td>
<td>Compare A1 and A2 accuracy</td>
</tr>
<tr class="even">
<td><code><a href="../reference/verify_jacobian.html">verify_jacobian()</a></code></td>
<td>Verify Jacobian against finite differences</td>
</tr>
</tbody>
</table>
</div>
<div class="section level3">
<h3 id="when-to-use-a2">When to Use A2<a class="anchor" aria-label="anchor" href="#when-to-use-a2"></a>
</h3>
<p><strong>Always use A2</strong> (via <code><a href="../reference/DPprior_fit.html">DPprior_fit()</a></code> with
default settings) when you need:</p>
<ul>
<li>Exact moment matching for publication-quality results</li>
<li>Reliable priors for small-to-moderate
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>J</mi><annotation encoding="application/x-tex">J</annotation></semantics></math>
(20‚Äì100)</li>
<li>Numerical precision for downstream MCMC or optimization</li>
</ul>
<p><strong>A1 alone may suffice</strong> only for:</p>
<ul>
<li>Quick exploratory analysis</li>
<li>Very large
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>J</mi><annotation encoding="application/x-tex">J</annotation></semantics></math>
(where A1 error is negligible)</li>
<li>Applications where ~10-50% moment error is acceptable</li>
</ul>
</div>
</div>
<div class="section level2">
<h2 id="whats-next">What‚Äôs Next?<a class="anchor" aria-label="anchor" href="#whats-next"></a>
</h2>
<ul>
<li><p><strong><a href="theory-error.html">Error
Quantification</a></strong>: Detailed analysis of A1 approximation
errors and when they matter</p></li>
<li><p><strong><a href="dual-anchor.html">Dual-Anchor
Framework</a></strong>: Extending A2 to simultaneously match cluster and
weight targets</p></li>
<li><p><strong><a href="applied-guide.html">Applied Guide</a></strong>:
Practical workflow for eliciting priors in real applications</p></li>
</ul>
</div>
<div class="section level2">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<p>Arratia, R., Barbour, A. D., &amp; Tavar√©, S. (2000). The number of
components in a logarithmic combinatorial structure. <em>Annals of
Applied Probability</em>, 10(3), 691‚Äì731.</p>
<p>Casella, G., &amp; Berger, R. L. (2002). <em>Statistical
Inference</em> (2nd ed.). Duxbury Press.</p>
<p>Lee, J., Che, J., Rabe-Hesketh, S., Feller, A., &amp; Miratrix, L.
(2025). Improving the estimation of site-specific effects and their
distribution in multisite trials. <em>Journal of Educational and
Behavioral Statistics</em>, 50(5), 731‚Äì764. <a href="https://doi.org/10.3102/10769986241254286" class="external-link uri">https://doi.org/10.3102/10769986241254286</a></p>
<p>Nocedal, J., &amp; Wright, S. J. (2006). <em>Numerical
Optimization</em> (2nd ed.). Springer.</p>
<p>Ortega, J. M., &amp; Rheinboldt, W. C. (1970). <em>Iterative Solution
of Nonlinear Equations in Several Variables</em>. Academic Press.</p>
<hr>
<p><em>For questions about this vignette or the DPprior package, please
visit the <a href="https://github.com/joonho112/DPprior" class="external-link">GitHub
repository</a>.</em></p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by <a href="https://github.com/joonho112" class="external-link">JoonHo Lee</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
