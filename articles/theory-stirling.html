<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Technical Deep Dive: Stirling Numbers and the Antoniak Distribution • DPprior</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Technical Deep Dive: Stirling Numbers and the Antoniak Distribution">
<meta name="description" content="A comprehensive treatment of unsigned Stirling numbers of the first kind,  numerically stable log-space computation, and their application to the  Antoniak distribution for exact computation of P(K_J = k | α).
">
<meta property="og:description" content="A comprehensive treatment of unsigned Stirling numbers of the first kind,  numerically stable log-space computation, and their application to the  Antoniak distribution for exact computation of P(K_J = k | α).
">
<meta property="og:image" content="https://joonho112.github.io/DPprior/logo.svg">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">DPprior</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-vignettes" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Vignettes</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-vignettes">
<li><h6 class="dropdown-header" data-toc-skip>--- Applied Track ---</h6></li>
    <li><a class="dropdown-item" href="../articles/introduction.html">Introduction</a></li>
    <li><a class="dropdown-item" href="../articles/quick-start.html">Quick Start</a></li>
    <li><a class="dropdown-item" href="../articles/applied-guide.html">Applied Guide</a></li>
    <li><a class="dropdown-item" href="../articles/dual-anchor.html">Dual-Anchor Framework</a></li>
    <li><a class="dropdown-item" href="../articles/diagnostics.html">Diagnostics</a></li>
    <li><a class="dropdown-item" href="../articles/case-studies.html">Case Studies</a></li>
    <li><h6 class="dropdown-header" data-toc-skip>--- Methodological Track ---</h6></li>
    <li><a class="dropdown-item" href="../articles/theory-overview.html">Theory Overview</a></li>
    <li><a class="dropdown-item" href="../articles/theory-stirling.html">Stirling Numbers</a></li>
    <li><a class="dropdown-item" href="../articles/theory-approximations.html">Approximations (A1)</a></li>
    <li><a class="dropdown-item" href="../articles/theory-newton.html">Newton Algorithm (A2)</a></li>
    <li><a class="dropdown-item" href="../articles/theory-weights.html">Weight Distributions</a></li>
    <li><a class="dropdown-item" href="../articles/api-reference.html">API Reference</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/joonho112/DPprior/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.svg" class="logo" alt=""><h1>Technical Deep Dive: Stirling Numbers and the Antoniak Distribution</h1>
                        <h4 data-toc-skip class="author">JoonHo Lee</h4>
            
            <h4 data-toc-skip class="date">2026-02-13</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/joonho112/DPprior/blob/main/vignettes/theory-stirling.Rmd" class="external-link"><code>vignettes/theory-stirling.Rmd</code></a></small>
      <div class="d-none name"><code>theory-stirling.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="overview">Overview<a class="anchor" aria-label="anchor" href="#overview"></a>
</h2>
<p>This vignette provides a deep technical treatment of the
computational machinery underlying the Antoniak distribution—the exact
probability mass function (PMF) for the number of distinct clusters
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>K</mi><mi>J</mi></msub><annotation encoding="application/x-tex">K_J</annotation></semantics></math>
in a Dirichlet Process (DP) model. We focus specifically on
<strong>unsigned Stirling numbers of the first kind</strong> and their
numerically stable computation, which forms the core of the DPprior
package’s reference computational layer.</p>
<p>This vignette is intended for statisticians and methodological
researchers who want to understand the exact implementation details. We
cover:</p>
<ol style="list-style-type: decimal">
<li>The combinatorial definition and properties of unsigned Stirling
numbers</li>
<li>The computational challenge: why naive implementation fails</li>
<li>Log-space computation via the <code>logsumexp</code> trick</li>
<li>Computing the Antoniak PMF from Stirling numbers</li>
<li>Numerical stability analysis and implementation guards</li>
</ol>
<p>Throughout, we distinguish between <strong>established
results</strong> from the combinatorics and Bayesian nonparametrics
literature and <strong>implementation contributions</strong> of this
package.</p>
</div>
<div class="section level2">
<h2 id="unsigned-stirling-numbers-of-the-first-kind">1. Unsigned Stirling Numbers of the First Kind<a class="anchor" aria-label="anchor" href="#unsigned-stirling-numbers-of-the-first-kind"></a>
</h2>
<div class="section level3">
<h3 id="definition-and-combinatorial-interpretation">1.1 Definition and Combinatorial Interpretation<a class="anchor" aria-label="anchor" href="#definition-and-combinatorial-interpretation"></a>
</h3>
<p>The <strong>unsigned Stirling numbers of the first kind</strong>,
denoted
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="true" form="prefix">|</mo><mi>s</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>J</mi><mo>,</mo><mi>k</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">|</mo></mrow><annotation encoding="application/x-tex">|s(J, k)|</annotation></semantics></math>,
count the number of permutations of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>J</mi><annotation encoding="application/x-tex">J</annotation></semantics></math>
elements that consist of exactly
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>k</mi><annotation encoding="application/x-tex">k</annotation></semantics></math>
disjoint cycles.</p>
<p><strong>Example.</strong> For
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>J</mi><mo>=</mo><mn>3</mn></mrow><annotation encoding="application/x-tex">J = 3</annotation></semantics></math>
elements
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false" form="prefix">{</mo><mn>1</mn><mo>,</mo><mn>2</mn><mo>,</mo><mn>3</mn><mo stretchy="false" form="postfix">}</mo></mrow><annotation encoding="application/x-tex">\{1, 2, 3\}</annotation></semantics></math>,
the permutations grouped by number of cycles are:</p>
<table class="table">
<thead><tr class="header">
<th><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>k</mi><annotation encoding="application/x-tex">k</annotation></semantics></math></th>
<th>Permutations</th>
<th>Count
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false" form="postfix">∥</mo><mi>s</mi><mrow><mo stretchy="true" form="prefix">(</mo><mn>3</mn><mo>,</mo><mi>k</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="false" form="postfix">∥</mo></mrow><annotation encoding="application/x-tex">\|s(3,k)\|</annotation></semantics></math>
</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>1</td>
<td><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mrow><mo stretchy="true" form="prefix">(</mo><mn>1</mn><mspace width="0.222em"></mspace><mn>2</mn><mspace width="0.222em"></mspace><mn>3</mn><mo stretchy="true" form="postfix">)</mo></mrow><mo>,</mo><mrow><mo stretchy="true" form="prefix">(</mo><mn>1</mn><mspace width="0.222em"></mspace><mn>3</mn><mspace width="0.222em"></mspace><mn>2</mn><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">(1\ 2\ 3), (1\ 3\ 2)</annotation></semantics></math></td>
<td>2</td>
</tr>
<tr class="even">
<td>2</td>
<td><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mrow><mo stretchy="true" form="prefix">(</mo><mn>1</mn><mo stretchy="true" form="postfix">)</mo></mrow><mrow><mo stretchy="true" form="prefix">(</mo><mn>2</mn><mspace width="0.222em"></mspace><mn>3</mn><mo stretchy="true" form="postfix">)</mo></mrow><mo>,</mo><mrow><mo stretchy="true" form="prefix">(</mo><mn>2</mn><mo stretchy="true" form="postfix">)</mo></mrow><mrow><mo stretchy="true" form="prefix">(</mo><mn>1</mn><mspace width="0.222em"></mspace><mn>3</mn><mo stretchy="true" form="postfix">)</mo></mrow><mo>,</mo><mrow><mo stretchy="true" form="prefix">(</mo><mn>3</mn><mo stretchy="true" form="postfix">)</mo></mrow><mrow><mo stretchy="true" form="prefix">(</mo><mn>1</mn><mspace width="0.222em"></mspace><mn>2</mn><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">(1)(2\ 3), (2)(1\ 3), (3)(1\ 2)</annotation></semantics></math></td>
<td>3</td>
</tr>
<tr class="odd">
<td>3</td>
<td><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mrow><mo stretchy="true" form="prefix">(</mo><mn>1</mn><mo stretchy="true" form="postfix">)</mo></mrow><mrow><mo stretchy="true" form="prefix">(</mo><mn>2</mn><mo stretchy="true" form="postfix">)</mo></mrow><mrow><mo stretchy="true" form="prefix">(</mo><mn>3</mn><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">(1)(2)(3)</annotation></semantics></math></td>
<td>1</td>
</tr>
</tbody>
</table>
<p>The total is
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2</mn><mo>+</mo><mn>3</mn><mo>+</mo><mn>1</mn><mo>=</mo><mn>6</mn><mo>=</mo><mn>3</mn><mi>!</mi></mrow><annotation encoding="application/x-tex">2 + 3 + 1 = 6 = 3!</annotation></semantics></math>,
as expected since we’re partitioning all permutations.</p>
<p><strong>Attribution.</strong> Stirling numbers have a rich history in
combinatorics, dating back to James Stirling’s 1730 work <em>Methodus
Differentialis</em>. The connection to the DP cluster distribution was
established by Antoniak (1974).</p>
</div>
<div class="section level3">
<h3 id="recurrence-relation">1.2 Recurrence Relation<a class="anchor" aria-label="anchor" href="#recurrence-relation"></a>
</h3>
<p>The unsigned Stirling numbers satisfy a fundamental recurrence:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mrow><mo stretchy="true" form="prefix">|</mo><mi>s</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>J</mi><mo>,</mo><mi>k</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">|</mo></mrow><mo>=</mo><mrow><mo stretchy="true" form="prefix">|</mo><mi>s</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>J</mi><mo>−</mo><mn>1</mn><mo>,</mo><mi>k</mi><mo>−</mo><mn>1</mn><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">|</mo></mrow><mo>+</mo><mrow><mo stretchy="true" form="prefix">(</mo><mi>J</mi><mo>−</mo><mn>1</mn><mo stretchy="true" form="postfix">)</mo></mrow><mo>⋅</mo><mrow><mo stretchy="true" form="prefix">|</mo><mi>s</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>J</mi><mo>−</mo><mn>1</mn><mo>,</mo><mi>k</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">|</mo></mrow></mrow><annotation encoding="application/x-tex">
|s(J, k)| = |s(J-1, k-1)| + (J-1) \cdot |s(J-1, k)|
</annotation></semantics></math></p>
<p><strong>Combinatorial interpretation:</strong> When adding element
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>J</mi><annotation encoding="application/x-tex">J</annotation></semantics></math>
to a permutation of elements
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false" form="prefix">{</mo><mn>1</mn><mo>,</mo><mi>…</mi><mo>,</mo><mi>J</mi><mo>−</mo><mn>1</mn><mo stretchy="false" form="postfix">}</mo></mrow><annotation encoding="application/x-tex">\{1, \ldots, J-1\}</annotation></semantics></math>:</p>
<ul>
<li>Element
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>J</mi><annotation encoding="application/x-tex">J</annotation></semantics></math>
can form a <strong>new cycle by itself</strong>: this accounts for
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="true" form="prefix">|</mo><mi>s</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>J</mi><mo>−</mo><mn>1</mn><mo>,</mo><mi>k</mi><mo>−</mo><mn>1</mn><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">|</mo></mrow><annotation encoding="application/x-tex">|s(J-1, k-1)|</annotation></semantics></math>
permutations (we need
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi><mo>−</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">k-1</annotation></semantics></math>
cycles in the first
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>J</mi><mo>−</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">J-1</annotation></semantics></math>
elements)</li>
<li>Element
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>J</mi><annotation encoding="application/x-tex">J</annotation></semantics></math>
can be <strong>inserted into any position</strong> within an existing
cycle: there are
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="true" form="prefix">(</mo><mi>J</mi><mo>−</mo><mn>1</mn><mo stretchy="true" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">(J-1)</annotation></semantics></math>
positions to insert, and we need
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>k</mi><annotation encoding="application/x-tex">k</annotation></semantics></math>
cycles already present, giving
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mrow><mo stretchy="true" form="prefix">(</mo><mi>J</mi><mo>−</mo><mn>1</mn><mo stretchy="true" form="postfix">)</mo></mrow><mo>⋅</mo><mrow><mo stretchy="true" form="prefix">|</mo><mi>s</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>J</mi><mo>−</mo><mn>1</mn><mo>,</mo><mi>k</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">|</mo></mrow></mrow><annotation encoding="application/x-tex">(J-1) \cdot |s(J-1, k)|</annotation></semantics></math>
</li>
</ul>
</div>
<div class="section level3">
<h3 id="boundary-conditions">1.3 Boundary Conditions<a class="anchor" aria-label="anchor" href="#boundary-conditions"></a>
</h3>
<p>The recurrence requires the following boundary conditions:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><mrow><mo stretchy="true" form="prefix">|</mo><mi>s</mi><mrow><mo stretchy="true" form="prefix">(</mo><mn>0</mn><mo>,</mo><mn>0</mn><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">|</mo></mrow></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><mn>1</mn><mspace width="1.0em"></mspace><mtext mathvariant="normal">(empty permutation: one way to arrange nothing)</mtext></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"><mrow><mo stretchy="true" form="prefix">|</mo><mi>s</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>J</mi><mo>,</mo><mn>0</mn><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">|</mo></mrow></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><mn>0</mn><mspace width="1.0em"></mspace><mrow><mtext mathvariant="normal">for </mtext><mspace width="0.333em"></mspace></mrow><mi>J</mi><mo>≥</mo><mn>1</mn><mrow><mspace width="0.333em"></mspace><mtext mathvariant="normal"> (no permutation has 0 cycles)</mtext></mrow></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"><mrow><mo stretchy="true" form="prefix">|</mo><mi>s</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>J</mi><mo>,</mo><mi>J</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">|</mo></mrow></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><mn>1</mn><mspace width="1.0em"></mspace><mrow><mtext mathvariant="normal">for all </mtext><mspace width="0.333em"></mspace></mrow><mi>J</mi><mrow><mspace width="0.333em"></mspace><mtext mathvariant="normal"> (only the identity has </mtext><mspace width="0.333em"></mspace></mrow><mi>J</mi><mrow><mspace width="0.333em"></mspace><mtext mathvariant="normal"> cycles)</mtext></mrow></mtd></mtr></mtable><annotation encoding="application/x-tex">
\begin{aligned}
|s(0, 0)| &amp;= 1 \quad \text{(empty permutation: one way to arrange nothing)} \\
|s(J, 0)| &amp;= 0 \quad \text{for } J \geq 1 \text{ (no permutation has 0 cycles)} \\
|s(J, J)| &amp;= 1 \quad \text{for all } J \text{ (only the identity has } J \text{ cycles)}
\end{aligned}
</annotation></semantics></math></p>
</div>
<div class="section level3">
<h3 id="fundamental-identity">1.4 Fundamental Identity<a class="anchor" aria-label="anchor" href="#fundamental-identity"></a>
</h3>
<p>A crucial identity that serves as a computational verification
is:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><munderover><mo>∑</mo><mrow><mi>k</mi><mo>=</mo><mn>1</mn></mrow><mi>J</mi></munderover><mrow><mo stretchy="true" form="prefix">|</mo><mi>s</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>J</mi><mo>,</mo><mi>k</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">|</mo></mrow><mo>=</mo><mi>J</mi><mi>!</mi></mrow><annotation encoding="application/x-tex">
\sum_{k=1}^{J} |s(J, k)| = J!
</annotation></semantics></math></p>
<p>This follows immediately from the fact that we’re partitioning all
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>J</mi><mi>!</mi></mrow><annotation encoding="application/x-tex">J!</annotation></semantics></math>
permutations according to their cycle count.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Compute log-Stirling numbers up to J = 15</span></span>
<span><span class="va">logS</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/compute_log_stirling.html">compute_log_stirling</a></span><span class="op">(</span><span class="fl">15</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Verify known values</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Verification of known Stirling numbers:\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Verification of known Stirling numbers:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"  |s(4, 2)| = %d (expected: 11)\n"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">logS</span><span class="op">[</span><span class="fl">5</span>, <span class="fl">3</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;   |s(4, 2)| = 11 (expected: 11)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"  |s(5, 3)| = %d (expected: 35)\n"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">logS</span><span class="op">[</span><span class="fl">6</span>, <span class="fl">4</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;   |s(5, 3)| = 35 (expected: 35)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"  |s(6, 3)| = %d (expected: 225)\n"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">logS</span><span class="op">[</span><span class="fl">7</span>, <span class="fl">4</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;   |s(6, 3)| = 225 (expected: 225)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"  |s(10, 5)| = %d (expected: 269325)\n"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">logS</span><span class="op">[</span><span class="fl">11</span>, <span class="fl">6</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;   |s(10, 5)| = 269325 (expected: 269325)</span></span>
<span></span>
<span><span class="co"># Verify row sum = J!</span></span>
<span><span class="va">J_test</span> <span class="op">&lt;-</span> <span class="fl">10</span></span>
<span><span class="va">log_row_sum</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/logsumexp_vec.html">logsumexp_vec</a></span><span class="op">(</span><span class="va">logS</span><span class="op">[</span><span class="va">J_test</span> <span class="op">+</span> <span class="fl">1</span>, <span class="fl">2</span><span class="op">:</span><span class="op">(</span><span class="va">J_test</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">log_factorial</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">J_test</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"\nRow sum identity for J = %d:\n"</span>, <span class="va">J_test</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Row sum identity for J = 10:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"  sum_k |s(%d,k)| = %.0f\n"</span>, <span class="va">J_test</span>, <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">log_row_sum</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;   sum_k |s(10,k)| = 3628800</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"  %d! = %.0f\n"</span>, <span class="va">J_test</span>, <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">log_factorial</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;   10! = 3628800</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"  Relative error: %.2e\n"</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">log_row_sum</span> <span class="op">-</span> <span class="va">log_factorial</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Relative error: 0.00e+00</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="the-computational-challenge">2. The Computational Challenge<a class="anchor" aria-label="anchor" href="#the-computational-challenge"></a>
</h2>
<div class="section level3">
<h3 id="explosive-growth-of-stirling-numbers">2.1 Explosive Growth of Stirling Numbers<a class="anchor" aria-label="anchor" href="#explosive-growth-of-stirling-numbers"></a>
</h3>
<p>The unsigned Stirling numbers grow extremely rapidly—faster than
exponential. Consider some representative values:</p>
<table class="table">
<caption>Magnitude of Stirling numbers for various J</caption>
<colgroup>
<col width="5%">
<col width="25%">
<col width="30%">
<col width="38%">
</colgroup>
<thead><tr class="header">
<th align="right">J</th>
<th align="right">|s(J, 1)|</th>
<th align="right">|s(J, ⌊J/2⌋)|</th>
<th align="right">log₁₀(max |s(J,k)|)</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="right">10</td>
<td align="right">3.6288e+05</td>
<td align="right">2.69325e+05</td>
<td align="right">5.56</td>
</tr>
<tr class="even">
<td align="right">20</td>
<td align="right">1.2200e+17</td>
<td align="right">1.40000e+13</td>
<td align="right">17.09</td>
</tr>
<tr class="odd">
<td align="right">50</td>
<td align="right">6.0800e+62</td>
<td align="right">1.05000e+52</td>
<td align="right">62.78</td>
</tr>
<tr class="even">
<td align="right">100</td>
<td align="right">9.3300e+156</td>
<td align="right">3.70000e+130</td>
<td align="right">156.97</td>
</tr>
<tr class="odd">
<td align="right">200</td>
<td align="right">NA</td>
<td align="right">NA</td>
<td align="right">373.02</td>
</tr>
</tbody>
</table>
<p>For
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>J</mi><mo>=</mo><mn>100</mn></mrow><annotation encoding="application/x-tex">J = 100</annotation></semantics></math>,
the maximum Stirling number is approximately
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msup><mn>10</mn><mn>157</mn></msup><annotation encoding="application/x-tex">10^{157}</annotation></semantics></math>,
far exceeding the range of double-precision floating point
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>≈</mo><msup><mn>10</mn><mn>308</mn></msup></mrow><annotation encoding="application/x-tex">\approx 10^{308}</annotation></semantics></math>
maximum, but with only 15-17 significant digits).</p>
<p><strong>The key insight:</strong> Direct computation in the original
scale is impossible for any practical
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>J</mi><annotation encoding="application/x-tex">J</annotation></semantics></math>.
We must work entirely in log-space.</p>
</div>
<div class="section level3">
<h3 id="why-naive-log-space-fails">2.2 Why Naive Log-Space Fails<a class="anchor" aria-label="anchor" href="#why-naive-log-space-fails"></a>
</h3>
<p>One might think: “Just take logs of everything!” But consider the
recurrence:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mrow><mo stretchy="true" form="prefix">|</mo><mi>s</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>J</mi><mo>,</mo><mi>k</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">|</mo></mrow><mo>=</mo><mrow><mo stretchy="true" form="prefix">|</mo><mi>s</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>J</mi><mo>−</mo><mn>1</mn><mo>,</mo><mi>k</mi><mo>−</mo><mn>1</mn><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">|</mo></mrow><mo>+</mo><mrow><mo stretchy="true" form="prefix">(</mo><mi>J</mi><mo>−</mo><mn>1</mn><mo stretchy="true" form="postfix">)</mo></mrow><mo>⋅</mo><mrow><mo stretchy="true" form="prefix">|</mo><mi>s</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>J</mi><mo>−</mo><mn>1</mn><mo>,</mo><mi>k</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">|</mo></mrow></mrow><annotation encoding="application/x-tex">
|s(J, k)| = |s(J-1, k-1)| + (J-1) \cdot |s(J-1, k)|
</annotation></semantics></math></p>
<p>In log-space, this becomes:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>log</mo><mrow><mo stretchy="true" form="prefix">|</mo><mi>s</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>J</mi><mo>,</mo><mi>k</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">|</mo></mrow><mo>=</mo><mo>log</mo><mrow><mo stretchy="true" form="prefix">(</mo><msup><mi>e</mi><msub><mi>L</mi><mrow><mi>J</mi><mo>−</mo><mn>1</mn><mo>,</mo><mi>k</mi><mo>−</mo><mn>1</mn></mrow></msub></msup><mo>+</mo><mrow><mo stretchy="true" form="prefix">(</mo><mi>J</mi><mo>−</mo><mn>1</mn><mo stretchy="true" form="postfix">)</mo></mrow><mo>⋅</mo><msup><mi>e</mi><msub><mi>L</mi><mrow><mi>J</mi><mo>−</mo><mn>1</mn><mo>,</mo><mi>k</mi></mrow></msub></msup><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">
\log|s(J, k)| = \log\left(e^{L_{J-1,k-1}} + (J-1) \cdot e^{L_{J-1,k}}\right)
</annotation></semantics></math></p>
<p>where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>L</mi><mrow><mi>J</mi><mo>,</mo><mi>k</mi></mrow></msub><mo>:=</mo><mo>log</mo><mrow><mo stretchy="true" form="prefix">|</mo><mi>s</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>J</mi><mo>,</mo><mi>k</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">|</mo></mrow></mrow><annotation encoding="application/x-tex">L_{J,k} := \log|s(J,k)|</annotation></semantics></math>.
The problem: we need to compute
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>log</mo><mrow><mo stretchy="true" form="prefix">(</mo><msup><mi>e</mi><mi>a</mi></msup><mo>+</mo><msup><mi>e</mi><mi>b</mi></msup><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\log(e^a + e^b)</annotation></semantics></math>
where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>a</mi><annotation encoding="application/x-tex">a</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>b</mi><annotation encoding="application/x-tex">b</annotation></semantics></math>
may be very large (causing overflow when exponentiating) or very
different in magnitude (causing underflow when adding).</p>
</div>
</div>
<div class="section level2">
<h2 id="the-logsumexp-trick">3. The <code>logsumexp</code> Trick<a class="anchor" aria-label="anchor" href="#the-logsumexp-trick"></a>
</h2>
<div class="section level3">
<h3 id="mathematical-foundation">3.1 Mathematical Foundation<a class="anchor" aria-label="anchor" href="#mathematical-foundation"></a>
</h3>
<p>The <code>logsumexp</code> function computes
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>log</mo><mrow><mo stretchy="true" form="prefix">(</mo><msup><mi>e</mi><mi>a</mi></msup><mo>+</mo><msup><mi>e</mi><mi>b</mi></msup><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\log(e^a + e^b)</annotation></semantics></math>
in a numerically stable way using the identity:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>log</mo><mrow><mo stretchy="true" form="prefix">(</mo><msup><mi>e</mi><mi>a</mi></msup><mo>+</mo><msup><mi>e</mi><mi>b</mi></msup><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mo>max</mo><mrow><mo stretchy="true" form="prefix">(</mo><mi>a</mi><mo>,</mo><mi>b</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>+</mo><mo>log</mo><mrow><mo stretchy="true" form="prefix">(</mo><mn>1</mn><mo>+</mo><msup><mi>e</mi><mrow><mo>−</mo><mrow><mo stretchy="true" form="prefix">|</mo><mi>a</mi><mo>−</mo><mi>b</mi><mo stretchy="true" form="postfix">|</mo></mrow></mrow></msup><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">
\log(e^a + e^b) = \max(a, b) + \log\left(1 + e^{-|a-b|}\right)
</annotation></semantics></math></p>
<p><strong>Why this works:</strong></p>
<ol style="list-style-type: decimal">
<li>The maximum is factored out, so we never exponentiate a large
number</li>
<li>The argument to
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mo>exp</mo><annotation encoding="application/x-tex">\exp</annotation></semantics></math>
is always
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>≤</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">\leq 0</annotation></semantics></math>,
preventing overflow</li>
<li>We use <code>log1p(x)</code> =
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>log</mo><mrow><mo stretchy="true" form="prefix">(</mo><mn>1</mn><mo>+</mo><mi>x</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\log(1 + x)</annotation></semantics></math>
for numerical stability near
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">x = 0</annotation></semantics></math>
</li>
</ol>
</div>
<div class="section level3">
<h3 id="implementation-and-verification">3.2 Implementation and Verification<a class="anchor" aria-label="anchor" href="#implementation-and-verification"></a>
</h3>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Demonstrate numerical stability</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"logsumexp numerical stability:\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; logsumexp numerical stability:</span></span>
<span></span>
<span><span class="co"># Case 1: Both arguments very large</span></span>
<span><span class="va">a</span> <span class="op">&lt;-</span> <span class="fl">1000</span></span>
<span><span class="va">b</span> <span class="op">&lt;-</span> <span class="fl">1000</span></span>
<span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/logsumexp.html">logsumexp</a></span><span class="op">(</span><span class="va">a</span>, <span class="va">b</span><span class="op">)</span></span>
<span><span class="va">expected</span> <span class="op">&lt;-</span> <span class="fl">1000</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span>  <span class="co"># log(e^1000 + e^1000) = 1000 + log(2)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"  logsumexp(1000, 1000) = %.6f (expected: %.6f)\n"</span>, <span class="va">result</span>, <span class="va">expected</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;   logsumexp(1000, 1000) = 1000.693147 (expected: 1000.693147)</span></span>
<span></span>
<span><span class="co"># Case 2: Both arguments very negative</span></span>
<span><span class="va">a</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="fl">1000</span></span>
<span><span class="va">b</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="fl">1000</span></span>
<span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/logsumexp.html">logsumexp</a></span><span class="op">(</span><span class="va">a</span>, <span class="va">b</span><span class="op">)</span></span>
<span><span class="va">expected</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="fl">1000</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"  logsumexp(-1000, -1000) = %.6f (expected: %.6f)\n"</span>, <span class="va">result</span>, <span class="va">expected</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;   logsumexp(-1000, -1000) = -999.306853 (expected: -999.306853)</span></span>
<span></span>
<span><span class="co"># Case 3: Large difference in magnitude</span></span>
<span><span class="va">a</span> <span class="op">&lt;-</span> <span class="fl">1000</span></span>
<span><span class="va">b</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="fl">1000</span></span>
<span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/logsumexp.html">logsumexp</a></span><span class="op">(</span><span class="va">a</span>, <span class="va">b</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"  logsumexp(1000, -1000) = %.6f (essentially 1000)\n"</span>, <span class="va">result</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;   logsumexp(1000, -1000) = 1000.000000 (essentially 1000)</span></span>
<span></span>
<span><span class="co"># Case 4: Typical use case - log-sum of probabilities</span></span>
<span><span class="va">log_p1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">0.3</span><span class="op">)</span></span>
<span><span class="va">log_p2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">0.7</span><span class="op">)</span></span>
<span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="fu"><a href="../reference/logsumexp.html">logsumexp</a></span><span class="op">(</span><span class="va">log_p1</span>, <span class="va">log_p2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"  exp(logsumexp(log(0.3), log(0.7))) = %.6f\n"</span>, <span class="va">result</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;   exp(logsumexp(log(0.3), log(0.7))) = 1.000000</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="vectorized-version">3.3 Vectorized Version<a class="anchor" aria-label="anchor" href="#vectorized-version"></a>
</h3>
<p>For computing
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>log</mo><msubsup><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>n</mi></msubsup><msup><mi>e</mi><msub><mi>x</mi><mi>i</mi></msub></msup></mrow><annotation encoding="application/x-tex">\log\sum_{i=1}^n e^{x_i}</annotation></semantics></math>,
we use the vectorized extension:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>log</mo><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>n</mi></munderover><msup><mi>e</mi><msub><mi>x</mi><mi>i</mi></msub></msup><mo>=</mo><munder><mo>max</mo><mi>i</mi></munder><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>x</mi><mi>i</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>+</mo><mo>log</mo><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>n</mi></munderover><msup><mi>e</mi><mrow><msub><mi>x</mi><mi>i</mi></msub><mo>−</mo><munder><mo>max</mo><mi>i</mi></munder><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>x</mi><mi>i</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow></msup></mrow><annotation encoding="application/x-tex">
\log\sum_{i=1}^n e^{x_i} = \max_i(x_i) + \log\sum_{i=1}^n e^{x_i - \max_i(x_i)}
</annotation></semantics></math></p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Demonstrate vectorized logsumexp</span></span>
<span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">100</span>, <span class="fl">101</span>, <span class="fl">102</span>, <span class="fl">103</span><span class="op">)</span></span>
<span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/logsumexp_vec.html">logsumexp_vec</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"logsumexp_vec([100, 101, 102, 103]) = %.4f\n"</span>, <span class="va">result</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; logsumexp_vec([100, 101, 102, 103]) = 103.4402</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"This equals: log(e^100 + e^101 + e^102 + e^103) ≈ log(e^103 * 1.52) = %.4f\n"</span>, </span>
<span>            <span class="fl">103</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="fl">2</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="fl">3</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; This equals: log(e^100 + e^101 + e^102 + e^103) ≈ log(e^103 * 1.52) = 103.4402</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="computing-the-log-stirling-matrix">4. Computing the Log-Stirling Matrix<a class="anchor" aria-label="anchor" href="#computing-the-log-stirling-matrix"></a>
</h2>
<div class="section level3">
<h3 id="the-algorithm">4.1 The Algorithm<a class="anchor" aria-label="anchor" href="#the-algorithm"></a>
</h3>
<p>The <code><a href="../reference/compute_log_stirling.html">compute_log_stirling()</a></code> function builds the complete
lower-triangular matrix of log-Stirling numbers using the recursion:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>L</mi><mrow><mi>J</mi><mo>,</mo><mi>k</mi></mrow></msub><mo>=</mo><mtext mathvariant="normal">logsumexp</mtext><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>L</mi><mrow><mi>J</mi><mo>−</mo><mn>1</mn><mo>,</mo><mi>k</mi><mo>−</mo><mn>1</mn></mrow></msub><mo>,</mo><mo>log</mo><mrow><mo stretchy="true" form="prefix">(</mo><mi>J</mi><mo>−</mo><mn>1</mn><mo stretchy="true" form="postfix">)</mo></mrow><mo>+</mo><msub><mi>L</mi><mrow><mi>J</mi><mo>−</mo><mn>1</mn><mo>,</mo><mi>k</mi></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">
L_{J,k} = \text{logsumexp}(L_{J-1,k-1}, \log(J-1) + L_{J-1,k})
</annotation></semantics></math></p>
<p><strong>Complexity:</strong>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mrow><mo stretchy="true" form="prefix">(</mo><msubsup><mi>J</mi><mo>max</mo><mn>2</mn></msubsup><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">O(J_{\max}^2)</annotation></semantics></math>
time and space.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Compute the full log-Stirling matrix for J up to 50</span></span>
<span><span class="va">J_max</span> <span class="op">&lt;-</span> <span class="fl">50</span></span>
<span><span class="va">logS</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/compute_log_stirling.html">compute_log_stirling</a></span><span class="op">(</span><span class="va">J_max</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"Log-Stirling matrix dimensions: %d x %d\n"</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">logS</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">logS</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Log-Stirling matrix dimensions: 51 x 51</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"Memory usage: %.2f KB\n"</span>, <span class="fu"><a href="https://rdrr.io/r/utils/object.size.html" class="external-link">object.size</a></span><span class="op">(</span><span class="va">logS</span><span class="op">)</span> <span class="op">/</span> <span class="fl">1024</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Memory usage: 20.53 KB</span></span>
<span></span>
<span><span class="co"># Display a small section of the matrix (J = 1 to 10)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"\nlog|s(J, k)| for J = 1..10, k = 1..10:\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; log|s(J, k)| for J = 1..10, k = 1..10:</span></span>
<span><span class="va">small_section</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">logS</span><span class="op">[</span><span class="fl">2</span><span class="op">:</span><span class="fl">11</span>, <span class="fl">2</span><span class="op">:</span><span class="fl">11</span><span class="op">]</span>, <span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">small_section</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"J ="</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">small_section</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"k ="</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">small_section</span><span class="op">)</span></span>
<span><span class="co">#&gt;        k = 1 k = 2 k = 3 k = 4 k = 5 k = 6 k = 7 k = 8 k = 9 k = 10</span></span>
<span><span class="co">#&gt; J = 1   0.00  -Inf  -Inf  -Inf  -Inf  -Inf  -Inf  -Inf  -Inf   -Inf</span></span>
<span><span class="co">#&gt; J = 2   0.00  0.00  -Inf  -Inf  -Inf  -Inf  -Inf  -Inf  -Inf   -Inf</span></span>
<span><span class="co">#&gt; J = 3   0.69  1.10  0.00  -Inf  -Inf  -Inf  -Inf  -Inf  -Inf   -Inf</span></span>
<span><span class="co">#&gt; J = 4   1.79  2.40  1.79  0.00  -Inf  -Inf  -Inf  -Inf  -Inf   -Inf</span></span>
<span><span class="co">#&gt; J = 5   3.18  3.91  3.56  2.30  0.00  -Inf  -Inf  -Inf  -Inf   -Inf</span></span>
<span><span class="co">#&gt; J = 6   4.79  5.61  5.42  4.44  2.71  0.00  -Inf  -Inf  -Inf   -Inf</span></span>
<span><span class="co">#&gt; J = 7   6.58  7.48  7.39  6.60  5.16  3.04  0.00  -Inf  -Inf   -Inf</span></span>
<span><span class="co">#&gt; J = 8   8.53  9.48  9.48  8.82  7.58  5.77  3.33  0.00  -Inf   -Inf</span></span>
<span><span class="co">#&gt; J = 9  10.60 11.60 11.68 11.12 10.02  8.42  6.30  3.58  0.00   -Inf</span></span>
<span><span class="co">#&gt; J = 10 12.80 13.84 13.97 13.49 12.50 11.06  9.15  6.77  3.81      0</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="verification-via-row-sums">4.2 Verification via Row Sums<a class="anchor" aria-label="anchor" href="#verification-via-row-sums"></a>
</h3>
<p>We can verify the computation by checking that row sums equal
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>log</mo><mrow><mo stretchy="true" form="prefix">(</mo><mi>J</mi><mi>!</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\log(J!)</annotation></semantics></math>:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Verify row sum identity for multiple J values</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Verification of sum_k |s(J,k)| = J!:\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Verification of sum_k |s(J,k)| = J!:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"%5s %15s %15s %12s\n"</span>, <span class="st">"J"</span>, <span class="st">"sum |s(J,k)|"</span>, <span class="st">"J!"</span>, <span class="st">"Rel. Error"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;     J    sum |s(J,k)|              J!   Rel. Error</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/strrep.html" class="external-link">strrep</a></span><span class="op">(</span><span class="st">"-"</span>, <span class="fl">48</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; ------------------------------------------------</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">J</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">10</span>, <span class="fl">20</span>, <span class="fl">30</span>, <span class="fl">40</span>, <span class="fl">50</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">log_row_sum</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/logsumexp_vec.html">logsumexp_vec</a></span><span class="op">(</span><span class="va">logS</span><span class="op">[</span><span class="va">J</span> <span class="op">+</span> <span class="fl">1</span>, <span class="fl">2</span><span class="op">:</span><span class="op">(</span><span class="va">J</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">log_factorial</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">J</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">rel_error</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">log_row_sum</span> <span class="op">-</span> <span class="va">log_factorial</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Display in scientific notation for large values</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"%5d %15.4e %15.4e %12.2e\n"</span>, </span>
<span>              <span class="va">J</span>, <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">log_row_sum</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">log_factorial</span><span class="op">)</span>, <span class="va">rel_error</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt;     5      1.2000e+02      1.2000e+02     0.00e+00</span></span>
<span><span class="co">#&gt;    10      3.6288e+06      3.6288e+06     0.00e+00</span></span>
<span><span class="co">#&gt;    20      2.4329e+18      2.4329e+18     7.11e-15</span></span>
<span><span class="co">#&gt;    30      2.6525e+32      2.6525e+32     1.42e-14</span></span>
<span><span class="co">#&gt;    40      8.1592e+47      8.1592e+47     1.42e-14</span></span>
<span><span class="co">#&gt;    50      3.0414e+64      3.0414e+64     2.84e-14</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="the-antoniak-distribution">5. The Antoniak Distribution<a class="anchor" aria-label="anchor" href="#the-antoniak-distribution"></a>
</h2>
<div class="section level3">
<h3 id="exact-pmf-of-k_j-alpha">5.1 Exact PMF of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>K</mi><mi>J</mi></msub><mo stretchy="false" form="prefix">|</mo><mi>α</mi></mrow><annotation encoding="application/x-tex">K_J | \alpha</annotation></semantics></math><a class="anchor" aria-label="anchor" href="#exact-pmf-of-k_j-alpha"></a>
</h3>
<p>The fundamental result connecting Stirling numbers to the DP cluster
distribution is the <strong>Antoniak distribution</strong> (Antoniak,
1974):</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>Pr</mo><mo stretchy="false" form="prefix">(</mo><msub><mi>K</mi><mi>J</mi></msub><mo>=</mo><mi>k</mi><mrow><mo stretchy="true" form="prefix">|</mo><mi>α</mi><mo stretchy="false" form="postfix">)</mo><mo>=</mo><mo stretchy="true" form="postfix">|</mo></mrow><mi>s</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>J</mi><mo>,</mo><mi>k</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="false" form="prefix">|</mo><mo>⋅</mo><mfrac><msup><mi>α</mi><mi>k</mi></msup><msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>α</mi><mo stretchy="true" form="postfix">)</mo></mrow><mi>J</mi></msub></mfrac><mo>,</mo><mspace width="1.0em"></mspace><mi>k</mi><mo>=</mo><mn>1</mn><mo>,</mo><mi>…</mi><mo>,</mo><mi>J</mi></mrow><annotation encoding="application/x-tex">
\Pr(K_J = k | \alpha) = |s(J, k)| \cdot \frac{\alpha^k}{(\alpha)_J}, \quad k = 1, \ldots, J
</annotation></semantics></math></p>
<p>where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>α</mi><mo stretchy="true" form="postfix">)</mo></mrow><mi>J</mi></msub><mo>=</mo><mi>α</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>α</mi><mo>+</mo><mn>1</mn><mo stretchy="true" form="postfix">)</mo></mrow><mi>⋯</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>α</mi><mo>+</mo><mi>J</mi><mo>−</mo><mn>1</mn><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mfrac><mrow><mi>Γ</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>α</mi><mo>+</mo><mi>J</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><mrow><mi>Γ</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>α</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow></mfrac></mrow><annotation encoding="application/x-tex">(\alpha)_J = \alpha(\alpha+1)\cdots(\alpha+J-1) = \frac{\Gamma(\alpha+J)}{\Gamma(\alpha)}</annotation></semantics></math>
is the rising factorial (Pochhammer symbol).</p>
<p><strong>Attribution.</strong> This formula was derived by Antoniak
(1974) and is foundational to the Bayesian nonparametrics literature. It
is restated in modern DP prior-elicitation work including Dorazio
(2009), Murugiah and Sweeting (2012), and Vicentini and Jermyn (2025).
Zito, Rigon, and Dunson (2024) present the general Gibbs-type form
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>Pr</mo><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>K</mi><mi>J</mi></msub><mo>=</mo><mi>k</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><msub><mi>V</mi><mrow><mi>J</mi><mo>,</mo><mi>k</mi></mrow></msub><mrow><mo stretchy="true" form="prefix">|</mo><mi>s</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>J</mi><mo>,</mo><mi>k</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">|</mo></mrow></mrow><annotation encoding="application/x-tex">\Pr(K_J = k) = V_{J,k} |s(J,k)|</annotation></semantics></math>.</p>
</div>
<div class="section level3">
<h3 id="log-space-computation">5.2 Log-Space Computation<a class="anchor" aria-label="anchor" href="#log-space-computation"></a>
</h3>
<p>In log-space, the PMF becomes:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>log</mo><mo>Pr</mo><mo stretchy="false" form="prefix">(</mo><msub><mi>K</mi><mi>J</mi></msub><mo>=</mo><mi>k</mi><mrow><mo stretchy="true" form="prefix">|</mo><mi>α</mi><mo stretchy="false" form="postfix">)</mo><mo>=</mo><mo>log</mo><mo stretchy="true" form="postfix">|</mo></mrow><mi>s</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>J</mi><mo>,</mo><mi>k</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="false" form="prefix">|</mo><mo>+</mo><mi>k</mi><mo>log</mo><mi>α</mi><mo>−</mo><mo>log</mo><msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>α</mi><mo stretchy="true" form="postfix">)</mo></mrow><mi>J</mi></msub></mrow><annotation encoding="application/x-tex">
\log \Pr(K_J = k | \alpha) = \log|s(J, k)| + k \log\alpha - \log(\alpha)_J
</annotation></semantics></math></p>
<p>where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>log</mo><msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>α</mi><mo stretchy="true" form="postfix">)</mo></mrow><mi>J</mi></msub><mo>=</mo><mo>log</mo><mi>Γ</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>α</mi><mo>+</mo><mi>J</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>−</mo><mo>log</mo><mi>Γ</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>α</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\log(\alpha)_J = \log\Gamma(\alpha + J) - \log\Gamma(\alpha)</annotation></semantics></math>.</p>
<p><strong>Normalization:</strong> The PMF is computed in log-space and
then converted to probabilities via the softmax function, which
ensures:</p>
<ol style="list-style-type: decimal">
<li>Numerical stability for extreme parameter values</li>
<li>Exact normalization to sum to 1</li>
</ol>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Compute the Antoniak PMF for J = 50, alpha = 2</span></span>
<span><span class="va">J</span> <span class="op">&lt;-</span> <span class="fl">50</span></span>
<span><span class="va">alpha</span> <span class="op">&lt;-</span> <span class="fl">2</span></span>
<span></span>
<span><span class="va">pmf</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/pmf_K_given_alpha.html">pmf_K_given_alpha</a></span><span class="op">(</span><span class="va">J</span>, <span class="va">alpha</span>, <span class="va">logS</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Verify normalization</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"PMF normalization check: sum(pmf) = %.10f\n"</span>, <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">pmf</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; PMF normalization check: sum(pmf) = 1.0000000000</span></span>
<span></span>
<span><span class="co"># Summary statistics</span></span>
<span><span class="va">k_vals</span> <span class="op">&lt;-</span> <span class="fl">0</span><span class="op">:</span><span class="va">J</span></span>
<span><span class="va">mean_K</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">k_vals</span> <span class="op">*</span> <span class="va">pmf</span><span class="op">)</span></span>
<span><span class="va">var_K</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">k_vals</span><span class="op">^</span><span class="fl">2</span> <span class="op">*</span> <span class="va">pmf</span><span class="op">)</span> <span class="op">-</span> <span class="va">mean_K</span><span class="op">^</span><span class="fl">2</span></span>
<span><span class="va">mode_K</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.min.html" class="external-link">which.max</a></span><span class="op">(</span><span class="va">pmf</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"\nDistribution of K_%d | α = %g:\n"</span>, <span class="va">J</span>, <span class="va">alpha</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Distribution of K_50 | α = 2:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"  E[K] = %.4f\n"</span>, <span class="va">mean_K</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;   E[K] = 7.0376</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"  Var(K) = %.4f\n"</span>, <span class="va">var_K</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Var(K) = 4.5356</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"  Mode(K) = %d\n"</span>, <span class="va">mode_K</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Mode(K) = 7</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"  SD(K) = %.4f\n"</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">var_K</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;   SD(K) = 2.1297</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="visualization">5.3 Visualization<a class="anchor" aria-label="anchor" href="#visualization"></a>
</h3>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Compute PMF for several alpha values</span></span>
<span><span class="va">alpha_values</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">5</span>, <span class="fl">10</span><span class="op">)</span></span>
<span><span class="va">J</span> <span class="op">&lt;-</span> <span class="fl">50</span></span>
<span></span>
<span><span class="va">pmf_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">alpha_values</span>, <span class="kw">function</span><span class="op">(</span><span class="va">a</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">pmf</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/pmf_K_given_alpha.html">pmf_K_given_alpha</a></span><span class="op">(</span><span class="va">J</span>, <span class="va">a</span>, <span class="va">logS</span><span class="op">)</span></span>
<span>  <span class="va">k_range</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="fl">35</span>, <span class="va">J</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>    k <span class="op">=</span> <span class="va">k_range</span>,</span>
<span>    pmf <span class="op">=</span> <span class="va">pmf</span><span class="op">[</span><span class="va">k_range</span> <span class="op">+</span> <span class="fl">1</span><span class="op">]</span>,</span>
<span>    alpha <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"α = "</span>, <span class="va">a</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="va">pmf_data</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">k</span>, y <span class="op">=</span> <span class="va">pmf</span>, color <span class="op">=</span> <span class="va">alpha</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_line</span><span class="op">(</span>linewidth <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_point</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_color_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"#E41A1C"</span>, <span class="st">"#377EB8"</span>, <span class="st">"#4DAF4A"</span>, <span class="st">"#984EA3"</span>, <span class="st">"#FF7F00"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html" class="external-link">expression</a></span><span class="op">(</span><span class="va">k</span> <span class="op">~</span> <span class="st">"(number of clusters)"</span><span class="op">)</span>,</span>
<span>    y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html" class="external-link">expression</a></span><span class="op">(</span><span class="fu">Pr</span><span class="op">(</span><span class="va">K</span><span class="op">[</span><span class="fl">50</span><span class="op">]</span> <span class="op">==</span> <span class="va">k</span> <span class="op">~</span> <span class="st">"|"</span> <span class="op">~</span> <span class="va">alpha</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    title <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html" class="external-link">expression</a></span><span class="op">(</span><span class="st">"Antoniak Distribution: "</span> <span class="op">*</span> <span class="fu">Pr</span><span class="op">(</span><span class="va">K</span><span class="op">[</span><span class="va">J</span><span class="op">]</span> <span class="op">==</span> <span class="va">k</span> <span class="op">~</span> <span class="st">"|"</span> <span class="op">~</span> <span class="va">alpha</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    subtitle <span class="op">=</span> <span class="st">"J = 50 observations"</span>,</span>
<span>    color <span class="op">=</span> <span class="st">"Concentration"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_minimal</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span></span>
<span>    legend.position <span class="op">=</span> <span class="st">"right"</span>,</span>
<span>    plot.title <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>face <span class="op">=</span> <span class="st">"bold"</span>, hjust <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span>,</span>
<span>    plot.subtitle <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="theory-stirling_files/figure-html/fig-antoniak-pmf-1.png" class="r-plt" alt="Antoniak PMF for various concentration parameters α with J = 50 observations." width="85%"><p class="caption">
Antoniak PMF for various concentration parameters α with J = 50
observations.
</p>
</div>
</div>
<div class="section level3">
<h3 id="comparison-with-the-poisson-binomial-representation">5.4 Comparison with the Poisson-Binomial Representation<a class="anchor" aria-label="anchor" href="#comparison-with-the-poisson-binomial-representation"></a>
</h3>
<p>The Antoniak distribution can be alternatively derived from the
Poisson-binomial representation (Theorem 1 in
<code>theory-overview</code>):</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>K</mi><mi>J</mi></msub><mover><mo>=</mo><mi>d</mi></mover><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>J</mi></munderover><msub><mi>B</mi><mi>i</mi></msub><mo>,</mo><mspace width="1.0em"></mspace><msub><mi>B</mi><mi>i</mi></msub><mo>∼</mo><mtext mathvariant="normal">Bernoulli</mtext><mrow><mo stretchy="true" form="prefix">(</mo><mfrac><mi>α</mi><mrow><mi>α</mi><mo>+</mo><mi>i</mi><mo>−</mo><mn>1</mn></mrow></mfrac><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">
K_J \stackrel{d}{=} \sum_{i=1}^{J} B_i, \quad B_i \sim \text{Bernoulli}\left(\frac{\alpha}{\alpha + i - 1}\right)
</annotation></semantics></math></p>
<p>This provides an independent verification of our Stirling-based
computation:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Monte Carlo simulation using Poisson-Binomial representation</span></span>
<span><span class="va">n_sim</span> <span class="op">&lt;-</span> <span class="fl">100000</span></span>
<span><span class="va">J</span> <span class="op">&lt;-</span> <span class="fl">50</span></span>
<span><span class="va">alpha</span> <span class="op">&lt;-</span> <span class="fl">2</span></span>
<span></span>
<span><span class="co"># Bernoulli success probabilities</span></span>
<span><span class="va">p</span> <span class="op">&lt;-</span> <span class="va">alpha</span> <span class="op">/</span> <span class="op">(</span><span class="va">alpha</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">J</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Simulate K_J</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">K_samples</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">replicate</a></span><span class="op">(</span><span class="va">n_sim</span>, <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">J</span><span class="op">)</span> <span class="op">&lt;</span> <span class="va">p</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Compare distributions</span></span>
<span><span class="va">k_range</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="fl">20</span></span>
<span><span class="va">pmf_stirling</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/pmf_K_given_alpha.html">pmf_K_given_alpha</a></span><span class="op">(</span><span class="va">J</span>, <span class="va">alpha</span>, <span class="va">logS</span><span class="op">)</span><span class="op">[</span><span class="va">k_range</span> <span class="op">+</span> <span class="fl">1</span><span class="op">]</span></span>
<span><span class="va">pmf_mc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tabulate.html" class="external-link">tabulate</a></span><span class="op">(</span><span class="va">K_samples</span>, nbins <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">K_samples</span><span class="op">)</span><span class="op">)</span><span class="op">[</span><span class="va">k_range</span><span class="op">]</span> <span class="op">/</span> <span class="va">n_sim</span></span>
<span></span>
<span><span class="va">comparison_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  k <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">k_range</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>  pmf <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">pmf_stirling</span>, <span class="va">pmf_mc</span><span class="op">)</span>,</span>
<span>  Method <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Stirling (exact)"</span>, <span class="st">"Monte Carlo (n=100K)"</span><span class="op">)</span>, each <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">k_range</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="va">comparison_df</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">k</span>, y <span class="op">=</span> <span class="va">pmf</span>, color <span class="op">=</span> <span class="va">Method</span>, shape <span class="op">=</span> <span class="va">Method</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_point</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">3</span>, alpha <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_color_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"#E41A1C"</span>, <span class="st">"#377EB8"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_shape_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">16</span>, <span class="fl">17</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html" class="external-link">expression</a></span><span class="op">(</span><span class="va">k</span><span class="op">)</span>,</span>
<span>    y <span class="op">=</span> <span class="st">"Probability"</span>,</span>
<span>    title <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html" class="external-link">expression</a></span><span class="op">(</span><span class="st">"Verification: Stirling vs. Poisson-Binomial Monte Carlo"</span><span class="op">)</span>,</span>
<span>    subtitle <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"J = %d, α = %g"</span>, <span class="va">J</span>, <span class="va">alpha</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_minimal</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span></span>
<span>    legend.position <span class="op">=</span> <span class="st">"bottom"</span>,</span>
<span>    plot.title <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>face <span class="op">=</span> <span class="st">"bold"</span>, hjust <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span>,</span>
<span>    plot.subtitle <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="co">#&gt; Warning: Removed 2 rows containing missing values or values outside the scale range</span></span>
<span><span class="co">#&gt; (`geom_point()`).</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="theory-stirling_files/figure-html/verify-poisson-binomial-1.png" class="r-plt" alt="Verification: Stirling-based PMF vs. Monte Carlo from the Poisson-Binomial representation." width="85%"><p class="caption">
Verification: Stirling-based PMF vs. Monte Carlo from the
Poisson-Binomial representation.
</p>
</div>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># Numerical comparison</span></span>
<span><span class="va">max_diff</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">pmf_stirling</span> <span class="op">-</span> <span class="va">pmf_mc</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"\nMaximum absolute difference between methods: %.2e\n"</span>, <span class="va">max_diff</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Maximum absolute difference between methods: NA</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="numerical-stability-analysis">6. Numerical Stability Analysis<a class="anchor" aria-label="anchor" href="#numerical-stability-analysis"></a>
</h2>
<div class="section level3">
<h3 id="critical-regions">6.1 Critical Regions<a class="anchor" aria-label="anchor" href="#critical-regions"></a>
</h3>
<p>The Antoniak PMF computation faces numerical challenges in extreme
parameter regions:</p>
<p><strong>Very small
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>α</mi><annotation encoding="application/x-tex">\alpha</annotation></semantics></math>
(&lt; 0.1):</strong> The distribution becomes highly concentrated at
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>K</mi><mi>J</mi></msub><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">K_J = 1</annotation></semantics></math>,
with
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>Pr</mo><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>K</mi><mi>J</mi></msub><mo>=</mo><mn>1</mn><mo stretchy="false" form="prefix">|</mo><mi>α</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>→</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">\Pr(K_J = 1 | \alpha) \to 1</annotation></semantics></math>
as
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>α</mi><mo>→</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">\alpha \to 0</annotation></semantics></math>.
This requires careful handling of probabilities very close to 1.</p>
<p><strong>Very large
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>α</mi><annotation encoding="application/x-tex">\alpha</annotation></semantics></math>
(&gt; 50):</strong> The distribution shifts toward
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>K</mi><mi>J</mi></msub><mo>≈</mo><mi>J</mi></mrow><annotation encoding="application/x-tex">K_J \approx J</annotation></semantics></math>,
and the log-probabilities for small
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>k</mi><annotation encoding="application/x-tex">k</annotation></semantics></math>
become extremely negative.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Examine behavior at extreme alpha values</span></span>
<span><span class="va">J</span> <span class="op">&lt;-</span> <span class="fl">50</span></span>
<span><span class="va">extreme_alphas</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.01</span>, <span class="fl">0.1</span>, <span class="fl">1</span>, <span class="fl">10</span>, <span class="fl">50</span>, <span class="fl">100</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"PMF stability at extreme α values (J = 50):\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; PMF stability at extreme α values (J = 50):</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"%8s %12s %12s %12s %12s\n"</span>, </span>
<span>            <span class="st">"α"</span>, <span class="st">"Pr(K=1)"</span>, <span class="st">"E[K]"</span>, <span class="st">"Mode(K)"</span>, <span class="st">"sum(pmf)"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;       α      Pr(K=1)         E[K]      Mode(K)     sum(pmf)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/strrep.html" class="external-link">strrep</a></span><span class="op">(</span><span class="st">"-"</span>, <span class="fl">60</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; ------------------------------------------------------------</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">a</span> <span class="kw">in</span> <span class="va">extreme_alphas</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">pmf</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/pmf_K_given_alpha.html">pmf_K_given_alpha</a></span><span class="op">(</span><span class="va">J</span>, <span class="va">a</span>, <span class="va">logS</span><span class="op">)</span></span>
<span>  <span class="va">k_vals</span> <span class="op">&lt;-</span> <span class="fl">0</span><span class="op">:</span><span class="va">J</span></span>
<span>  <span class="va">mean_K</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">k_vals</span> <span class="op">*</span> <span class="va">pmf</span><span class="op">)</span></span>
<span>  <span class="va">mode_K</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.min.html" class="external-link">which.max</a></span><span class="op">(</span><span class="va">pmf</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span></span>
<span>  <span class="va">sum_pmf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">pmf</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"%8.2f %12.6f %12.2f %12d %12.10f\n"</span>, </span>
<span>              <span class="va">a</span>, <span class="va">pmf</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="va">mean_K</span>, <span class="va">mode_K</span>, <span class="va">sum_pmf</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt;     0.01     0.956274         1.04            1 1.0000000000</span></span>
<span><span class="co">#&gt;     0.10     0.643925         1.43            1 1.0000000000</span></span>
<span><span class="co">#&gt;     1.00     0.020000         4.50            4 1.0000000000</span></span>
<span><span class="co">#&gt;    10.00     0.000000        18.34           18 1.0000000000</span></span>
<span><span class="co">#&gt;    50.00     0.000000        34.91           35 1.0000000000</span></span>
<span><span class="co">#&gt;   100.00     0.000000        40.71           41 1.0000000000</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="implementation-guards-in-dpprior">6.2 Implementation Guards in DPprior<a class="anchor" aria-label="anchor" href="#implementation-guards-in-dpprior"></a>
</h3>
<p>The DPprior package includes several defensive measures:</p>
<ol style="list-style-type: decimal">
<li><p><strong>Log-space computation throughout:</strong> All
intermediate calculations remain in log-space until the final
softmax</p></li>
<li><p><strong>Stable softmax:</strong> Uses the shifted exponential
trick to prevent overflow:
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>p</mi><mi>i</mi></msub><mo>=</mo><mo>exp</mo><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>x</mi><mi>i</mi></msub><mo>−</mo><msub><mo>max</mo><mi>j</mi></msub><msub><mi>x</mi><mi>j</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mi>/</mi><msub><mo>∑</mo><mi>j</mi></msub><mo>exp</mo><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>x</mi><mi>j</mi></msub><mo>−</mo><msub><mo>max</mo><mi>j</mi></msub><msub><mi>x</mi><mi>j</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">p_i = \exp(x_i - \max_j x_j) / \sum_j \exp(x_j - \max_j x_j)</annotation></semantics></math></p></li>
<li><p><strong>Input validation:</strong> The
<code><a href="../reference/assert_positive.html">assert_positive()</a></code> and <code><a href="../reference/assert_valid_J.html">assert_valid_J()</a></code> helpers
catch invalid inputs early</p></li>
<li><p><strong>Defensive renormalization:</strong> Final PMF vectors are
explicitly normalized to sum to 1</p></li>
</ol>
</div>
<div class="section level3">
<h3 id="digamma-function-stability">6.3 Digamma Function Stability<a class="anchor" aria-label="anchor" href="#digamma-function-stability"></a>
</h3>
<p>The conditional moments of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>K</mi><mi>J</mi></msub><mo stretchy="false" form="prefix">|</mo><mi>α</mi></mrow><annotation encoding="application/x-tex">K_J | \alpha</annotation></semantics></math>
involve the digamma function:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>μ</mi><mi>J</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>α</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mi>α</mi><mo>⋅</mo><mrow><mo stretchy="true" form="prefix">[</mo><mi>ψ</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>α</mi><mo>+</mo><mi>J</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>−</mo><mi>ψ</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>α</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">]</mo></mrow></mrow><annotation encoding="application/x-tex">
\mu_J(\alpha) = \alpha \cdot [\psi(\alpha + J) - \psi(\alpha)]
</annotation></semantics></math></p>
<p>For very small
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>α</mi><annotation encoding="application/x-tex">\alpha</annotation></semantics></math>,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ψ</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>α</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>→</mo><mo>−</mo><mi>∞</mi></mrow><annotation encoding="application/x-tex">\psi(\alpha) \to -\infty</annotation></semantics></math>,
which can cause numerical issues. The package uses threshold-based
switching to alternative formulations when needed:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Compare digamma-based moments with PMF-based computation</span></span>
<span><span class="va">J</span> <span class="op">&lt;-</span> <span class="fl">50</span></span>
<span></span>
<span><span class="va">alpha_test</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.01</span>, <span class="fl">0.1</span>, <span class="fl">0.5</span>, <span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">5</span>, <span class="fl">10</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Moment computation consistency check:\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Moment computation consistency check:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"%8s %12s %12s %12s\n"</span>, </span>
<span>            <span class="st">"α"</span>, <span class="st">"E[K] (ψ)"</span>, <span class="st">"E[K] (PMF)"</span>, <span class="st">"Rel. Diff"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;       α    E[K] (ψ)   E[K] (PMF)    Rel. Diff</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/strrep.html" class="external-link">strrep</a></span><span class="op">(</span><span class="st">"-"</span>, <span class="fl">48</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; ------------------------------------------------</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">a</span> <span class="kw">in</span> <span class="va">alpha_test</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Digamma-based computation</span></span>
<span>  <span class="va">mean_digamma</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mean_K_given_alpha.html">mean_K_given_alpha</a></span><span class="op">(</span><span class="va">J</span>, <span class="va">a</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># PMF-based computation</span></span>
<span>  <span class="va">pmf</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/pmf_K_given_alpha.html">pmf_K_given_alpha</a></span><span class="op">(</span><span class="va">J</span>, <span class="va">a</span>, <span class="va">logS</span><span class="op">)</span></span>
<span>  <span class="va">mean_pmf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="op">(</span><span class="fl">0</span><span class="op">:</span><span class="va">J</span><span class="op">)</span> <span class="op">*</span> <span class="va">pmf</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">rel_diff</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">mean_digamma</span> <span class="op">-</span> <span class="va">mean_pmf</span><span class="op">)</span> <span class="op">/</span> <span class="va">mean_pmf</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"%8.2f %12.6f %12.6f %12.2e\n"</span>, </span>
<span>              <span class="va">a</span>, <span class="va">mean_digamma</span>, <span class="va">mean_pmf</span>, <span class="va">rel_diff</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt;     0.01     1.044631     1.044631     8.50e-16</span></span>
<span><span class="co">#&gt;     0.10     1.432776     1.432776     1.08e-15</span></span>
<span><span class="co">#&gt;     0.50     2.937775     2.937775     2.12e-15</span></span>
<span><span class="co">#&gt;     1.00     4.499205     4.499205     1.38e-15</span></span>
<span><span class="co">#&gt;     2.00     7.037626     7.037626     2.90e-15</span></span>
<span><span class="co">#&gt;     5.00    12.460485    12.460485     2.14e-15</span></span>
<span><span class="co">#&gt;    10.00    18.342355    18.342355     2.13e-15</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="computational-performance">7. Computational Performance<a class="anchor" aria-label="anchor" href="#computational-performance"></a>
</h2>
<div class="section level3">
<h3 id="pre-computation-strategy">7.1 Pre-computation Strategy<a class="anchor" aria-label="anchor" href="#pre-computation-strategy"></a>
</h3>
<p>For typical use in prior elicitation (where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>J</mi><annotation encoding="application/x-tex">J</annotation></semantics></math>
is fixed for a given analysis), the log-Stirling matrix should be
computed once and cached:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Timing for log-Stirling matrix computation</span></span>
<span><span class="va">J_values</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">50</span>, <span class="fl">100</span>, <span class="fl">200</span>, <span class="fl">300</span>, <span class="fl">500</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Log-Stirling matrix computation times:\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Log-Stirling matrix computation times:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"%8s %15s %15s\n"</span>, <span class="st">"J_max"</span>, <span class="st">"Time (ms)"</span>, <span class="st">"Memory (KB)"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;    J_max       Time (ms)     Memory (KB)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/strrep.html" class="external-link">strrep</a></span><span class="op">(</span><span class="st">"-"</span>, <span class="fl">40</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; ----------------------------------------</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">J_max</span> <span class="kw">in</span> <span class="va">J_values</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">time_taken</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="va">logS_temp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/compute_log_stirling.html">compute_log_stirling</a></span><span class="op">(</span><span class="va">J_max</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span><span class="op">[</span><span class="st">"elapsed"</span><span class="op">]</span> <span class="op">*</span> <span class="fl">1000</span></span>
<span>  </span>
<span>  <span class="va">mem_kb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/object.size.html" class="external-link">object.size</a></span><span class="op">(</span><span class="va">logS_temp</span><span class="op">)</span> <span class="op">/</span> <span class="fl">1024</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"%8d %15.2f %15.1f\n"</span>, <span class="va">J_max</span>, <span class="va">time_taken</span>, <span class="va">mem_kb</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt;       50            9.00            20.5</span></span>
<span><span class="co">#&gt;      100           39.00            79.9</span></span>
<span><span class="co">#&gt;      200          163.00           315.8</span></span>
<span><span class="co">#&gt;      300          375.00           708.0</span></span>
<span><span class="co">#&gt;      500         1044.00          1961.2</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="pmf-computation-timing">7.2 PMF Computation Timing<a class="anchor" aria-label="anchor" href="#pmf-computation-timing"></a>
</h3>
<p>Once the Stirling matrix is cached, PMF computation is extremely
fast:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Pre-compute Stirling matrix</span></span>
<span><span class="va">logS_300</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/compute_log_stirling.html">compute_log_stirling</a></span><span class="op">(</span><span class="fl">300</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Time PMF computation for various J</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"\nPMF computation times (with pre-computed Stirling matrix):\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; PMF computation times (with pre-computed Stirling matrix):</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"%8s %8s %15s\n"</span>, <span class="st">"J"</span>, <span class="st">"α"</span>, <span class="st">"Time (μs)"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;        J       α      Time (μs)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/strrep.html" class="external-link">strrep</a></span><span class="op">(</span><span class="st">"-"</span>, <span class="fl">35</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; -----------------------------------</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">J</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">50</span>, <span class="fl">100</span>, <span class="fl">200</span>, <span class="fl">300</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">alpha</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">5</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">time_us</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">replicate</a></span><span class="op">(</span><span class="fl">100</span>, <span class="op">{</span></span>
<span>      <span class="va">t</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span><span class="fu"><a href="../reference/pmf_K_given_alpha.html">pmf_K_given_alpha</a></span><span class="op">(</span><span class="va">J</span>, <span class="va">alpha</span>, <span class="va">logS_300</span><span class="op">)</span><span class="op">)</span><span class="op">[</span><span class="st">"elapsed"</span><span class="op">]</span></span>
<span>    <span class="op">}</span><span class="op">)</span><span class="op">)</span> <span class="op">*</span> <span class="fl">1e6</span></span>
<span>    </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"%8d %8.1f %15.1f\n"</span>, <span class="va">J</span>, <span class="va">alpha</span>, <span class="va">time_us</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt;       50      1.0           120.0</span></span>
<span><span class="co">#&gt;       50      5.0            80.0</span></span>
<span><span class="co">#&gt;      100      1.0            90.0</span></span>
<span><span class="co">#&gt;      100      5.0            70.0</span></span>
<span><span class="co">#&gt;      200      1.0           130.0</span></span>
<span><span class="co">#&gt;      200      5.0           140.0</span></span>
<span><span class="co">#&gt;      300      1.0           220.0</span></span>
<span><span class="co">#&gt;      300      5.0           170.0</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="application-effect-of-j-on-the-distribution">8. Application: Effect of J on the Distribution<a class="anchor" aria-label="anchor" href="#application-effect-of-j-on-the-distribution"></a>
</h2>
<p>Understanding how the distribution of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>K</mi><mi>J</mi></msub><annotation encoding="application/x-tex">K_J</annotation></semantics></math>
changes with sample size
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>J</mi><annotation encoding="application/x-tex">J</annotation></semantics></math>
is crucial for prior elicitation. For fixed
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>α</mi><annotation encoding="application/x-tex">\alpha</annotation></semantics></math>:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Effect of J on K distribution</span></span>
<span><span class="va">alpha</span> <span class="op">&lt;-</span> <span class="fl">2</span></span>
<span><span class="va">J_values</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">20</span>, <span class="fl">50</span>, <span class="fl">100</span>, <span class="fl">200</span><span class="op">)</span></span>
<span></span>
<span><span class="va">logS_200</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/compute_log_stirling.html">compute_log_stirling</a></span><span class="op">(</span><span class="fl">200</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Compute PMFs for different J</span></span>
<span><span class="va">effect_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">J_values</span>, <span class="kw">function</span><span class="op">(</span><span class="va">J</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">pmf</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/pmf_K_given_alpha.html">pmf_K_given_alpha</a></span><span class="op">(</span><span class="va">J</span>, <span class="va">alpha</span>, <span class="va">logS_200</span><span class="op">)</span></span>
<span>  <span class="va">k_max</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="fl">30</span>, <span class="va">J</span><span class="op">)</span></span>
<span>  <span class="va">mean_K</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="op">(</span><span class="fl">0</span><span class="op">:</span><span class="va">J</span><span class="op">)</span> <span class="op">*</span> <span class="va">pmf</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>    k <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">k_max</span>,</span>
<span>    pmf <span class="op">=</span> <span class="va">pmf</span><span class="op">[</span><span class="fl">2</span><span class="op">:</span><span class="op">(</span><span class="va">k_max</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span><span class="op">]</span>,</span>
<span>    J <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"J = "</span>, <span class="va">J</span>, <span class="st">" (E[K] = "</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">mean_K</span>, <span class="fl">1</span><span class="op">)</span>, <span class="st">")"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="va">effect_data</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">k</span>, y <span class="op">=</span> <span class="va">pmf</span>, color <span class="op">=</span> <span class="va">J</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_line</span><span class="op">(</span>linewidth <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_point</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_color_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="va">palette_main</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html" class="external-link">expression</a></span><span class="op">(</span><span class="va">k</span> <span class="op">~</span> <span class="st">"(number of clusters)"</span><span class="op">)</span>,</span>
<span>    y <span class="op">=</span> <span class="st">"Probability"</span>,</span>
<span>    title <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html" class="external-link">expression</a></span><span class="op">(</span><span class="st">"Effect of Sample Size on "</span> <span class="op">*</span> <span class="va">K</span><span class="op">[</span><span class="va">J</span><span class="op">]</span> <span class="op">*</span> <span class="st">" Distribution"</span><span class="op">)</span>,</span>
<span>    subtitle <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html" class="external-link">expression</a></span><span class="op">(</span><span class="st">"Fixed "</span> <span class="op">*</span> <span class="va">alpha</span> <span class="op">*</span> <span class="st">" = 2"</span><span class="op">)</span>,</span>
<span>    color <span class="op">=</span> <span class="st">"Sample Size"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_minimal</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span></span>
<span>    legend.position <span class="op">=</span> <span class="st">"right"</span>,</span>
<span>    plot.title <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>face <span class="op">=</span> <span class="st">"bold"</span>, hjust <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span>,</span>
<span>    plot.subtitle <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="theory-stirling_files/figure-html/fig-J-effect-1.png" class="r-plt" alt="Effect of sample size J on the distribution of K for fixed α = 2." width="85%"><p class="caption">
Effect of sample size J on the distribution of K for fixed α = 2.
</p>
</div>
</div>
<div class="section level2">
<h2 id="summary">Summary<a class="anchor" aria-label="anchor" href="#summary"></a>
</h2>
<p>This vignette has provided a detailed treatment of the computational
machinery underlying the Antoniak distribution:</p>
<ol style="list-style-type: decimal">
<li><p><strong>Unsigned Stirling numbers</strong>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="true" form="prefix">|</mo><mi>s</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>J</mi><mo>,</mo><mi>k</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">|</mo></mrow><annotation encoding="application/x-tex">|s(J,k)|</annotation></semantics></math>
count permutations with exactly
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>k</mi><annotation encoding="application/x-tex">k</annotation></semantics></math>
cycles and satisfy a well-defined recurrence relation.</p></li>
<li><p><strong>Numerical challenge:</strong> Direct computation
overflows for
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>J</mi><mo>&gt;</mo><mn>20</mn></mrow><annotation encoding="application/x-tex">J &gt; 20</annotation></semantics></math>;
we must work entirely in log-space.</p></li>
<li><p><strong>The <code>logsumexp</code> trick</strong> enables stable
computation of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>log</mo><mrow><mo stretchy="true" form="prefix">(</mo><msup><mi>e</mi><mi>a</mi></msup><mo>+</mo><msup><mi>e</mi><mi>b</mi></msup><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\log(e^a + e^b)</annotation></semantics></math>
for any values of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>a</mi><annotation encoding="application/x-tex">a</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>b</mi><annotation encoding="application/x-tex">b</annotation></semantics></math>.</p></li>
<li><p><strong>The Antoniak distribution</strong> provides the exact PMF
of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>K</mi><mi>J</mi></msub><mo stretchy="false" form="prefix">|</mo><mi>α</mi></mrow><annotation encoding="application/x-tex">K_J | \alpha</annotation></semantics></math>
via Stirling numbers, computed stably in log-space.</p></li>
<li><p><strong>DPprior implementation:</strong> Pre-computes and caches
the log-Stirling matrix, enabling fast PMF evaluation for any
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>α</mi><annotation encoding="application/x-tex">\alpha</annotation></semantics></math>.</p></li>
</ol>
<p>The stable computation of the Antoniak PMF forms the foundation for
the package’s exact moment-matching algorithms (A2) described in
subsequent vignettes.</p>
</div>
<div class="section level2">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<p>Antoniak, C. E. (1974). Mixtures of Dirichlet processes with
applications to Bayesian nonparametric problems. <em>The Annals of
Statistics</em>, 2(6), 1152-1174.</p>
<p>Arratia, R., Barbour, A. D., &amp; Tavaré, S. (2003). <em>Logarithmic
Combinatorial Structures: A Probabilistic Approach</em>. European
Mathematical Society.</p>
<p>Dorazio, R. M. (2009). On selecting a prior for the precision
parameter of Dirichlet process mixture models. <em>Journal of
Statistical Planning and Inference</em>, 139(10), 3384-3390.</p>
<p>Murugiah, S., &amp; Sweeting, T. J. (2012). Selecting the precision
parameter prior in Dirichlet process mixture models. <em>Journal of
Statistical Planning and Inference</em>, 142(7), 1947-1959.</p>
<p>Vicentini, C., &amp; Jermyn, I. H. (2025). Prior selection for the
precision parameter of Dirichlet process mixtures.
<em>arXiv:2502.00864</em>.</p>
<p>Zito, A., Rigon, T., &amp; Dunson, D. B. (2024). Bayesian
nonparametric modeling of latent partitions via Stirling-gamma priors.
<em>arXiv:2306.02360</em>.</p>
</div>
<div class="section level2">
<h2 id="appendix-key-function-reference">Appendix: Key Function Reference<a class="anchor" aria-label="anchor" href="#appendix-key-function-reference"></a>
</h2>
<table class="table">
<colgroup>
<col width="43%">
<col width="56%">
</colgroup>
<thead><tr class="header">
<th>Function</th>
<th>Description</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code>compute_log_stirling(J_max)</code></td>
<td>Pre-compute log-Stirling matrix for
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>J</mi><mo>≤</mo><msub><mi>J</mi><mo>max</mo></msub></mrow><annotation encoding="application/x-tex">J \leq J_{\max}</annotation></semantics></math>
</td>
</tr>
<tr class="even">
<td><code>get_log_stirling(J, k, logS)</code></td>
<td>Safe accessor with bounds checking</td>
</tr>
<tr class="odd">
<td><code>validate_stirling(logS)</code></td>
<td>Verify against known reference values</td>
</tr>
<tr class="even">
<td><code>verify_stirling_row_sum(logS)</code></td>
<td>Verify
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mo>∑</mo><mi>k</mi></msub><mo stretchy="false" form="postfix">∥</mo><mi>s</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>J</mi><mo>,</mo><mi>k</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="false" form="postfix">∥</mo><mo>=</mo><mi>J</mi><mi>!</mi></mrow><annotation encoding="application/x-tex">\sum_k \|s(J,k)\| = J!</annotation></semantics></math>
identity</td>
</tr>
<tr class="odd">
<td><code>logsumexp(a, b)</code></td>
<td>Numerically stable
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>log</mo><mrow><mo stretchy="true" form="prefix">(</mo><msup><mi>e</mi><mi>a</mi></msup><mo>+</mo><msup><mi>e</mi><mi>b</mi></msup><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\log(e^a + e^b)</annotation></semantics></math>
</td>
</tr>
<tr class="even">
<td><code>logsumexp_vec(x)</code></td>
<td>Vectorized log-sum-exp</td>
</tr>
<tr class="odd">
<td><code>softmax(x)</code></td>
<td>Numerically stable softmax</td>
</tr>
<tr class="even">
<td><code>pmf_K_given_alpha(J, α, logS)</code></td>
<td>Antoniak PMF for
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>K</mi><mi>J</mi></msub><mo stretchy="false" form="postfix">∥</mo><mi>α</mi></mrow><annotation encoding="application/x-tex">K_J \| \alpha</annotation></semantics></math>
</td>
</tr>
<tr class="odd">
<td><code>log_pmf_K_given_alpha(J, α, logS)</code></td>
<td>Log-scale Antoniak PMF</td>
</tr>
</tbody>
</table>
<hr>
<p><em>For questions about this vignette or the DPprior package, please
visit the <a href="https://github.com/joonho112/DPprior" class="external-link">GitHub
repository</a>.</em></p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by <a href="https://github.com/joonho112" class="external-link">JoonHo Lee</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
