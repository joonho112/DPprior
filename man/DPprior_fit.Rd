% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/16_DPprior_fit.R
\name{DPprior_fit}
\alias{DPprior_fit}
\title{Fit a Gamma Hyperprior for DP Concentration Parameter}
\usage{
DPprior_fit(
  J,
  mu_K,
  var_K = NULL,
  confidence = c("medium", "low", "high"),
  method = c("A2-MN", "A1", "A2-KL"),
  target_pmf = NULL,
  check_diagnostics = TRUE,
  warn_dominance = TRUE,
  M = .QUAD_NODES_DEFAULT,
  verbose = FALSE,
  ...
)
}
\arguments{
\item{J}{Integer; sample size (number of sites/units). Must be positive
and not exceed the maximum supported value (default: 500).}

\item{mu_K}{Numeric; target expected number of clusters \code{E[K_J]}. Must be
in the range (1, J]. Note: mu_K = 1 is trivial (single cluster).}

\item{var_K}{Numeric; target variance of \code{K_J}. If NULL, computed from
the \code{confidence} argument. Must satisfy var_K <= (J-1)^2/4
(maximum possible variance for K in \{1,...,J\}).}

\item{confidence}{Character; alternative to var_K for specifying uncertainty.
One of:
\itemize{
\item "low": VIF = 5.0 (very high uncertainty, wide prior)
\item "medium": VIF = 2.5 (moderate uncertainty)
\item "high": VIF = 1.5 (low uncertainty, concentrated prior)
}
Only used if \code{var_K} is NULL.}

\item{method}{Character; calibration method. One of:
\itemize{
\item "A2-MN" (default): Exact moment matching via Newton's method.
Recommended for accurate calibration.
\item "A1": Fast closed-form approximation based on shifted NegBin.
Good for initial exploration or large J. Note: may project
var_K to feasible region if var_K < mu_K - 1.
\item "A2-KL": KL divergence minimization. Supports both moment
target (default) and custom target PMF via \code{target_pmf}.
}}

\item{target_pmf}{Numeric vector; optional custom target PMF for A2-KL.
If provided, A2-KL uses PMF matching mode. Length must equal J.}

\item{check_diagnostics}{Logical; if TRUE (default), compute comprehensive
diagnostics including weight distribution analysis.}

\item{warn_dominance}{Logical; if TRUE (default), issue a warning if the
prior implies high probability of a dominant cluster (P(w1 > 0.5) > 40\%).}

\item{M}{Integer; number of quadrature nodes for numerical integration.
Default is 80, which provides good accuracy for most cases.}

\item{verbose}{Logical; if TRUE, print progress messages during calibration.}

\item{...}{Additional arguments passed to method-specific functions.
Note: only matching formal arguments are forwarded to backends.}
}
\value{
An S3 object of class "DPprior_fit" containing:
\describe{
\item{a}{Numeric; shape parameter of the calibrated Gamma hyperprior.}
\item{b}{Numeric; rate parameter of the calibrated Gamma hyperprior.}
\item{J}{Integer; sample size used for calibration.}
\item{target}{List; target specification including mu_K, var_K,
confidence level (if used), and target type.}
\item{method}{Character; calibration method used.}
\item{converged}{Logical; whether the calibration converged.}
\item{iterations}{Integer; number of iterations (for iterative methods).}
\item{fit}{List; achieved moments (mu_K, var_K) and residual.}
\item{diagnostics}{List; comprehensive diagnostics (if requested).}
\item{solver_diagnostics}{List; backend solver details (if applicable).}
\item{trace}{Data frame; iteration history (for iterative methods).}
}
}
\description{
Main entry point for DPprior prior elicitation. Takes user-specified
cluster count expectations and returns calibrated Gamma(a, b) parameters.
}
\details{
This function provides a convenient interface for specifying beliefs about
the number of clusters and uncertainty, then calibrates a Gamma hyperprior
for the Dirichlet Process concentration parameter alpha.

This function is the primary interface for Design-Conditional Elicitation
(DCE) as described in Lee (2026). The underlying engine is Two-Stage Moment
Matching (TSMM): Stage 1 (A1) provides a closed-form initialization, and
Stage 2 (A2-MN) refines to exact moments via Newton iteration.

\subsection{Variance Constraints}{
The target variance must satisfy two constraints:
\enumerate{
\item Upper bound: \code{var_K <= (J-1)^2/4} (maximum possible variance
for a distribution on \{1,...,J\})
\item Lower bound (A1 only): \code{var_K >= mu_K - 1} (NegBin feasibility).
For A1, infeasible variance is projected to the boundary with a warning.
A2-MN does not have this constraint.
}
}

\subsection{Diagnostics}{
When \code{check_diagnostics = TRUE}, the function computes:
\itemize{
\item Alpha distribution: \code{E[alpha]}, \code{Var(alpha)}, \code{CV(alpha)}
\item K distribution: achieved moments, mode, quantiles
\item Weight distribution: \code{E[w_1]}, \code{P(w_1 > 0.5)}, dominance risk
\item Co-clustering: \code{E[rho]}, interpretation
}
Backend solver details are preserved in \code{solver_diagnostics}.
}
}
\examples{
# Basic usage with target moments
fit <- DPprior_fit(J = 50, mu_K = 5, var_K = 8)
print(fit)

# Using confidence level instead of explicit variance
fit_medium <- DPprior_fit(J = 50, mu_K = 5, confidence = "medium")
fit_low <- DPprior_fit(J = 50, mu_K = 5, confidence = "low")

# Quick approximation for exploration
fit_quick <- DPprior_fit(J = 50, mu_K = 5, var_K = 8, method = "A1")

# Verbose output for debugging
fit_verbose <- DPprior_fit(J = 50, mu_K = 5, var_K = 8, verbose = TRUE)

# Access results
fit$a  # Gamma shape
fit$b  # Gamma rate
fit$fit$mu_K  # Achieved mean
fit$diagnostics$weights$dominance_risk  # Dominance risk level

}
\references{
Lee, J. (2026). Design-Conditional Prior Elicitation for Dirichlet Process Mixtures.
\emph{arXiv preprint} arXiv:2602.06301.
}
\seealso{
\code{\link{DPprior_a1}} for A1 closed-form approximation,
\code{\link{DPprior_a2_newton}} for A2 Newton refinement,
\code{\link{DPprior_a2_kl}} for A2-KL divergence minimization,
\code{\link{DPprior_diagnostics}} for detailed diagnostics,
\code{\link{DPprior_dual}} for dual-anchor calibration with weight constraints.

Other elicitation: 
\code{\link{DPprior_a1}()},
\code{\link{DPprior_a2_kl}()},
\code{\link{DPprior_a2_newton}()},
\code{\link{DPprior_dual}()}
}
\concept{elicitation}
